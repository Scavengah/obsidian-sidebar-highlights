/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var It=Object.defineProperty;var qt=Object.getOwnPropertyDescriptor;var Wt=Object.getOwnPropertyNames;var Ut=Object.prototype.hasOwnProperty;var Yt=(_,r)=>{for(var t in r)It(_,t,{get:r[t],enumerable:!0})},jt=(_,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of Wt(r))!Ut.call(_,i)&&i!==t&&It(_,i,{get:()=>r[i],enumerable:!(e=qt(r,i))||e.enumerable});return _};var Kt=_=>jt(It({},"__esModule",{value:!0}),_);var Jt={};Yt(Jt,{CollectionsManager:()=>kt,default:()=>Mt});module.exports=Kt(Jt);var E=require("obsidian");var x=require("obsidian");var et=require("obsidian"),mt=class extends et.Modal{constructor(t,e){super(t);this.onSubmit=e}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Create a new collection"}),new et.Setting(t).setName("Collection name").setDesc("The name of your collection (Required)").addText(n=>{this.nameInput=n.inputEl,n.setPlaceholder("Important Highlights").onChange(o=>{let l=t.querySelector(".mod-cta");l&&(l.disabled=!o.trim())}),window.setTimeout(()=>n.inputEl.focus(),100)}),new et.Setting(t).setName("Collection description").setDesc("Provide more context about the collection (Optional)").addText(n=>{this.descriptionInput=n.inputEl,n.setPlaceholder("Research, etc.")});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let s=e.createEl("button",{text:"Create collection",cls:"mod-cta"});s.disabled=!0,s.addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.ctrlKey||n.metaKey)?this.handleSubmit():n.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new et.Notice("Collection name is required"),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}},pt=class extends et.Modal{constructor(t,e,i){super(t);this.collection=e,this.onSubmit=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Edit collection"}),new et.Setting(t).setName("Collection name").setDesc("The name of your collection (Required)").addText(n=>{this.nameInput=n.inputEl,n.setPlaceholder("Important Highlights").setValue(this.collection.name).onChange(o=>{let l=t.querySelector(".mod-cta");l&&(l.disabled=!o.trim())}),window.setTimeout(()=>{n.inputEl.focus(),n.inputEl.select()},100)}),new et.Setting(t).setName("Collection description").setDesc("Provide more context about the collection (Optional)").addText(n=>{this.descriptionInput=n.inputEl,n.setPlaceholder("Research, etc.").setValue(this.collection.description||"")});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save changes",cls:"mod-cta"}).addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.ctrlKey||n.metaKey)?this.handleSubmit():n.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new et.Notice("Collection name is required"),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}};var ct=require("obsidian"),ft=class{constructor(){this.activeDropdown=null;this.documentClickHandlers=[];this.keydownHandlers=[];this.isOpen=!1;this.checkboxElements=new Map;this.activeItems=[]}isDropdownOpen(){return this.isOpen}closeActiveDropdown(){this.activeDropdown&&this.activeDropdown.parentNode&&(this.activeDropdown.classList.remove("dropdown-constrained-height"),this.activeDropdown.style.removeProperty("--dropdown-max-height"),this.activeDropdown.style.removeProperty("--dropdown-top"),this.activeDropdown.style.removeProperty("--dropdown-left"),this.activeDropdown.parentNode.removeChild(this.activeDropdown)),this.activeDropdown=null,this.isOpen=!1,this.checkboxElements.clear(),this.activeItems=[],this.documentClickHandlers.forEach(r=>{document.removeEventListener("click",r)}),this.documentClickHandlers=[],this.keydownHandlers.forEach(r=>{document.removeEventListener("keydown",r)}),this.keydownHandlers=[]}showDropdown(r,t,e={position:"below"}){if(this.isOpen){this.closeActiveDropdown();return}let i=r.getBoundingClientRect(),s=document.createElement("div");s.className=`menu highlights-dropdown-menu ${e.className||""}`,s.classList.add("dropdown-positioned"),this.activeDropdown=s,this.isOpen=!0,this.activeItems=[...t];let n=t.filter(f=>!f.separator),o=t.findIndex(f=>!f.separator),l=t.length-1-[...t].reverse().findIndex(f=>!f.separator);t.forEach((f,D)=>{let H=document.createElement("div");if(f.separator){H.className="menu-separator",s.appendChild(H);return}if(H.className=`menu-item ${f.className||"highlights-dropdown-item"}`,D===o&&H.classList.add("first-menu-item"),D===l&&H.classList.add("last-menu-item"),n.length===1&&D===o&&H.classList.add("only-menu-item"),f.checked!==void 0){let b=document.createElement("div");b.className="highlights-dropdown-check",f.checked?((0,ct.setIcon)(b,"check"),H.classList.add("is-checked")):f.uncheckedIcon&&(0,ct.setIcon)(b,f.uncheckedIcon),H.appendChild(b);let M=f.id||`item-${D}`;this.checkboxElements.set(M,{element:H,checkDiv:b})}else if(f.icon){let b=document.createElement("div");b.className="menu-item-icon",(0,ct.setIcon)(b,f.icon),H.appendChild(b)}let I=document.createElement("span");I.textContent=f.text,H.appendChild(I),H.addEventListener("click",b=>{if(b.preventDefault(),b.stopPropagation(),f.onClick&&f.onClick(),f.checked!==void 0){let M=f.id||`item-${D}`,N=!f.checked;this.activeItems[D].checked=N,this.updateCheckboxState(M,N),this.checkShouldAutoClose()}}),s.appendChild(H)}),document.body.appendChild(s);let c=s.getBoundingClientRect(),h=c.height,a=c.width,g=window.innerHeight,d=window.innerWidth,u=g-i.bottom,m=i.top,p,C;u>=h+8?(p=i.bottom+4,s.classList.add("dropdown-positioned-below")):m>=h+8?(p=i.top-h-4,s.classList.add("dropdown-positioned-above")):u>m?(p=i.bottom+4,s.classList.add("dropdown-positioned-below-constrained"),s.style.setProperty("--dropdown-max-height",`${u-8}px`),s.classList.add("dropdown-constrained-height")):(p=8,s.classList.add("dropdown-positioned-above-constrained"),s.style.setProperty("--dropdown-max-height",`${i.top-12}px`),s.classList.add("dropdown-constrained-height")),C=i.left,i.left+a>d-8&&(C=Math.max(8,i.right-a)),s.classList.add("dropdown-left-aligned"),s.style.setProperty("--dropdown-top",`${p}px`),s.style.setProperty("--dropdown-left",`${C}px`);let w=f=>{!s.contains(f.target)&&!r.contains(f.target)&&this.closeActiveDropdown()};this.documentClickHandlers.push(w),window.setTimeout(()=>{document.addEventListener("click",w)},100);let S=f=>{f.key==="Escape"&&this.closeActiveDropdown()};this.keydownHandlers.push(S),document.addEventListener("keydown",S)}updateCheckboxState(r,t){let e=this.checkboxElements.get(r);if(!e)return;let{element:i,checkDiv:s}=e,n=this.activeItems.find(o=>(o.id||`item-${this.activeItems.indexOf(o)}`)===r);t?((0,ct.setIcon)(s,"check"),i.classList.add("is-checked")):(s.empty(),i.classList.remove("is-checked"),n&&n.uncheckedIcon&&(0,ct.setIcon)(s,n.uncheckedIcon))}checkShouldAutoClose(){this.activeItems.some(t=>t.checked!==void 0&&t.checked===!0)||window.setTimeout(()=>{this.closeActiveDropdown()},100)}updateAllCheckboxStates(r){this.activeItems.forEach((t,e)=>{if(t.checked!==void 0){let i=t.id||`item-${e}`;r.hasOwnProperty(i)&&(t.checked=r[i],this.updateCheckboxState(i,r[i]))}}),this.checkShouldAutoClose()}cleanup(){this.closeActiveDropdown()}};var Q=require("obsidian"),Ct=class{constructor(r){this.plugin=r}createFileContextMenu(r){let t=new Q.Menu;return t.addItem(e=>{e.setTitle("Open in new tab").setIcon("lucide-plus").onClick(()=>{this.plugin.app.workspace.openLinkText(r.path,"","tab")})}),t.addItem(e=>{e.setTitle("Open to the right").setIcon("lucide-separator-vertical").onClick(()=>{this.plugin.app.workspace.openLinkText(r.path,"","split")})}),t.addSeparator(),t}createHighlightItem(r,t,e={}){let i=r.createDiv({cls:`highlight-item-card${this.plugin.selectedHighlightId===t.id?" selected":""}`,attr:{"data-highlight-id":t.id}});return this.applyHighlightStyling(i,t),this.createHoverColorPicker(i,t,e),this.createQuoteSection(i,t,e),this.createActionsSection(i,t,e),this.createCommentsSection(i,t,e),i}applyHighlightStyling(r,t){if(t.isNativeComment)r.classList.add("highlight-native-comment"),r.style.setProperty("--hl-ui-rgb","128,128,128"),r.style.setProperty("--text-highlight-bg-rgb","128,128,128");else{t.type==="html"&&r.classList.add("highlight-origin-html");let e=t.color||this.plugin.settings.highlightColor,i=this.getColorClassName(e);r.classList.add(i),i==="highlight-color-default"&&(r.classList.remove("highlight-color-default"),r.classList.add("highlight-color-custom"),r.style.setProperty("--highlight-color",e))}this.plugin.selectedHighlightId===t.id&&r.classList.add("highlight-selected")}getColorClassName(r){return{[this.plugin.settings.customColors.yellow]:"highlight-color-yellow",[this.plugin.settings.customColors.red]:"highlight-color-red",[this.plugin.settings.customColors.teal]:"highlight-color-teal",[this.plugin.settings.customColors.blue]:"highlight-color-blue",[this.plugin.settings.customColors.green]:"highlight-color-green"}[r]||"highlight-color-default"}createQuoteSection(r,t,e){let i=r.createDiv({cls:"highlight-quote"});this.renderMarkdownToElement(i,t.text),e.searchTerm&&e.searchTerm.length>0&&this.highlightSearchMatches(i,e.searchTerm),this.addTagsToQuote(i,t,e),i.addEventListener("click",s=>{var n;(n=e.onHighlightClick)==null||n.call(e,t,s)}),i.addEventListener("mouseover",s=>{this.plugin.app.workspace.trigger("hover-link",{event:s,source:"sidebar-highlights",hoverParent:i,targetEl:i,linktext:t.filePath,state:{scroll:t.startOffset}})})}addTagsToQuote(r,t,e){let i=this.extractTagsFromHighlight(t);if(i.length>0){let s=r.createDiv({cls:"highlight-tags"});i.forEach(n=>{s.createEl("span",{cls:"highlight-tag",text:n}).addEventListener("click",l=>{var c;l.stopPropagation(),(c=e.onTagClick)==null||c.call(e,n)})})}}createActionsSection(r,t,e){if(e.showHighlightActions===!1)return;let i=r.createDiv({cls:"highlight-actions"});this.addFileNameInfo(i,t,e);let s=i.createDiv({cls:"highlight-info-container"});this.addStatsInfo(s,t,e),this.addActionButtons(i,t,e)}addFileNameInfo(r,t,e){var i;if(e.showFilename){let s=((i=t.filePath.split("/").pop())==null?void 0:i.replace(/\.md$/,""))||t.filePath,n=r.createEl("small",{cls:"highlight-filename",text:s,attr:{title:t.filePath}});n.addEventListener("click",o=>{var l;o.stopPropagation(),(l=e.onFileNameClick)==null||l.call(e,t.filePath,o)}),n.addEventListener("contextmenu",o=>{o.preventDefault(),o.stopPropagation();let l=this.plugin.app.vault.getAbstractFileByPath(t.filePath);if(l instanceof Q.TFile){let c=this.createFileContextMenu(l);this.plugin.app.workspace.trigger("file-menu",c,l,"sidebar-highlights"),c.showAtMouseEvent(o)}}),n.addEventListener("mouseover",o=>{this.plugin.app.workspace.trigger("hover-link",{event:o,source:"sidebar-highlights",hoverParent:n,targetEl:n,linktext:t.filePath})})}}addStatsInfo(r,t,e){var g;let i=t.line>=0?t.line+1:"Unknown",s=r.createDiv({cls:"highlight-info-line"}),n=s.createDiv({cls:"highlight-stats-section"});this.createInfoItem(n,"text",`${i}`,"highlight-line-info");let o=t.isNativeComment?0:((g=t.footnoteContents)==null?void 0:g.filter(d=>d.trim()!=="").length)||0,l=t.isNativeComment?"highlight-line-info highlight-comment-stat disabled":"highlight-line-info highlight-comment-stat clickable",c=this.createInfoItem(n,"message-square",`${o}`,l);t.isNativeComment||c.addEventListener("click",d=>{var u;d.stopPropagation(),(u=e.onCommentToggle)==null||u.call(e,t.id)});let h=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);this.createInfoItem(n,"folder-open",`${h}`,"highlight-line-info highlight-collection-stat clickable").addEventListener("click",d=>{var u;d.stopPropagation(),(u=e.onCollectionsMenu)==null||u.call(e,d,t)}),this.addTimestampToInfoLine(s,t,e)}createInfoItem(r,t,e,i){let s=r.createDiv({cls:i}),n=s.createDiv({cls:t==="message-square"?"comment-icon":"line-icon"});return(0,Q.setIcon)(n,t),s.createSpan({text:e}),s}addTimestampToInfoLine(r,t,e){if(!e.showTimestamp)return;let i=t,s=Array.isArray(i.commentTimestamps)?i.commentTimestamps.filter(a=>typeof a=="number"&&!Number.isNaN(a)):[],n=typeof t.createdAt=="number"&&!Number.isNaN(t.createdAt)?t.createdAt:s.length>0?s[0]:void 0;if(!n)return;let o=(0,Q.moment)(n),l=e.dateFormat?o.format(e.dateFormat):o.format("YYYY-MM-DD HH:mm:ss"),c=r.createDiv({cls:"highlight-timestamp-container"}),h=this.resolveLabelFromHighlight(t);if(h){let a=this._slugifyName(h),g=c.createEl("span",{cls:"highlight-color-label",text:h,attr:{role:"link",tabindex:"0"}}),d=u=>{var m;u.stopPropagation(),(m=this.plugin.collectionsManager)==null||m.toggleFilterByLabel(h,t.color||this.plugin.settings.highlightColor,a,u)};g.addEventListener("click",d),g.addEventListener("keydown",u=>{(u.key==="Enter"||u.key===" ")&&d(u)})}c.createDiv({cls:"highlight-timestamp-info",text:l,attr:{title:`Created: ${l}`}})}addActionButtons(r,t,e){r.createDiv({cls:"comment-buttons"})}createCommentsSection(r,t,e){var s;if(!e.isCommentsVisible)return;let i=r.createDiv({cls:"highlight-comments"});if(!t.isNativeComment){let n=((s=t.footnoteContents)==null?void 0:s.filter(o=>(o||"").trim()!==""))||[];if(n.length>0){let o=n.map((l,c)=>{let h=t.commentTimestamps&&t.commentTimestamps[c]!=null?t.commentTimestamps[c]:void 0,a=t.commentTypes&&t.commentTypes[c]?t.commentTypes[c]:void 0,g=a;return!g&&typeof h=="number"&&!Number.isNaN(h)&&(g="anchor"),g||(g="inline"),console.log("Comment mapping - content:",l.substring(0,30),"ts:",h,"typeRaw:",a,"finalType:",g),{content:l,ts:h,type:g}});o.sort((l,c)=>{var g,d;let h=(g=l.ts)!=null?g:1/0,a=(d=c.ts)!=null?d:1/0;return h-a}),o.forEach(({content:l,ts:c,type:h},a)=>{let g=i.createDiv({cls:"highlight-comment"}),u=g.createDiv({cls:"highlight-comment-body"}).createDiv({cls:"highlight-comment-line"});if(e.showTimestamp){let p=u.createSpan({cls:"highlight-comment-type-icon"});console.log("Comment type:",h,"ts:",c,"Content:",l.substring(0,50));let C=h==="anchor";(0,Q.setIcon)(p,C?"message-square":"file-text");let w=C?c:t.createdAt;if(typeof w=="number"&&!Number.isNaN(w)){let S=e.dateFormat?(0,Q.moment)(w).format(e.dateFormat):(0,Q.moment)(w).format("YYYY-MM-DD HH:mm:ss");u.createSpan({cls:"highlight-comment-datetime",text:" "+S+": "})}}let m=u.createDiv({cls:"highlight-comment-text"});this.renderMarkdownToElement(m,l),g.addEventListener("click",p=>{var C;p.stopPropagation(),(C=e.onCommentClick)==null||C.call(e,t,a,p)})})}}this.createAddCommentLine(i,t,e)}createAddCommentLine(r,t,e){let s=r.createDiv({cls:"highlight-add-row"}).createDiv({cls:"highlight-add-comment-line highlight-add-comment-icon-only"}),n=s.createDiv({cls:"highlight-add-comment-icon"});(0,Q.setIcon)(n,"message-square-plus"),s.addEventListener("click",o=>{var l,c;o.stopPropagation(),(c=(l=e.onAddMarkComment)!=null?l:e.onAddComment)==null||c(t)})}highlightSearchMatches(r,t){if(!t)return;let e=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(e,"gi"),s=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,null),n,o=[];for(;n=s.nextNode();)n.nodeValue&&n.nodeValue.trim()!==""&&!(n.parentElement&&n.parentElement.classList.contains("search-term-highlight"))&&o.push(n);o.forEach(l=>{let c=l.nodeValue,h=[],a=0,g;for(;(g=i.exec(c))!==null;){g.index>a&&h.push(document.createTextNode(c.substring(a,g.index)));let d=document.createElement("span");d.className="search-term-highlight",d.textContent=g[0],h.push(d),a=i.lastIndex}a<c.length&&h.push(document.createTextNode(c.substring(a))),h.length>0&&l.parentNode&&(h.forEach(d=>l.parentNode.insertBefore(d,l)),l.parentNode.removeChild(l))})}renderMarkdownToElement(r,t){r.empty();let e=t.replace(/>\s*>/g,`
`),i=this.parseMarkdownSegments(e);for(let s of i)if(s.type==="text"){let n=(s.content||"").split(`
`);for(let o=0;o<n.length;o++)o>0&&r.createEl("br"),r.appendText(n[o])}else if(s.type==="strong"){let n=r.createEl("strong");n.textContent=s.content||""}else if(s.type==="em"){let n=r.createEl("em");n.textContent=s.content||""}else if(s.type==="code"){let n=r.createEl("code");n.textContent=s.content||""}else if(s.type==="del"){let n=r.createEl("del");n.textContent=s.content||""}else if(s.type==="link"){let n=r.createEl("a");n.textContent=s.text||"",n.href=s.url||"",n.target="_blank"}else if(s.type==="wikilink"){let n=r.createEl("a");n.textContent=s.text||s.url||"",n.classList.add("internal-link"),n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();let l=s.url||"";this.plugin.app.workspace.openLinkText(l,"",!0)})}}parseMarkdownSegments(r){let t=[],e=[{regex:/\*\*(.*?)\*\*/g,type:"strong"},{regex:/__(.*?)__/g,type:"strong"},{regex:/~~(.*?)~~/g,type:"del"},{regex:/`([^`]+?)`/g,type:"code"},{regex:/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g,type:"wikilink"},{regex:/\[([^\]]+)\]\(([^)]+)\)/g,type:"link"}],i=[];for(let o of e){let l;for(o.regex.lastIndex=0;(l=o.regex.exec(r))!==null;)o.type==="link"?i.push({start:l.index,end:l.index+l[0].length,type:o.type,text:l[1],url:l[2]}):o.type==="wikilink"?i.push({start:l.index,end:l.index+l[0].length,type:o.type,url:l[1],text:l[2]||l[1]}):i.push({start:l.index,end:l.index+l[0].length,type:o.type,content:l[1]})}this.findItalicMatches(r,i),i.sort((o,l)=>o.start-l.start);let s=[];for(let o of i)s.some(l=>o.start>=l.start&&o.start<l.end||o.end>l.start&&o.end<=l.end)||s.push(o);let n=0;for(let o of s)n<o.start&&t.push({type:"text",content:r.substring(n,o.start)}),t.push(o),n=o.end;return n<r.length&&t.push({type:"text",content:r.substring(n)}),t}findItalicMatches(r,t){for(let e=0;e<r.length;e++)if(r[e]==="*"&&(e===0||r[e-1]!=="*")&&(e===r.length-1||r[e+1]!=="*")){for(let i=e+1;i<r.length;i++)if(r[i]==="*"&&(i===r.length-1||r[i+1]!=="*")&&(i===0||r[i-1]!=="*")){let s=r.substring(e+1,i);if(s.length>0&&s.indexOf("*")===-1){t.push({start:e,end:i+1,type:"em",content:s}),e=i;break}}}for(let e=0;e<r.length;e++)if(r[e]==="_"&&(e===0||r[e-1]!=="_")&&(e===r.length-1||r[e+1]!=="_")){for(let i=e+1;i<r.length;i++)if(r[i]==="_"&&(i===r.length-1||r[i+1]!=="_")&&(i===0||r[i-1]!=="_")){let s=r.substring(e+1,i);if(s.length>0&&s.indexOf("_")===-1){t.push({start:e,end:i+1,type:"em",content:s}),e=i;break}}}}extractTagsFromHighlight(r){let t=[];if(r.footnoteContents){for(let e of r.footnoteContents)if(e.trim()!==""){let i=e.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);i&&i.forEach(s=>{let n=s.substring(1);t.includes(n)||t.push(n)})}}return t}isColorChangeable(r){return!r.isNativeComment&&!this.isHtmlHighlight(r)}isHtmlHighlight(r){return r.type==="html"}createHoverColorPicker(r,t,e){if(!this.isColorChangeable(t))return;let i=r.createDiv({cls:"highlight-border-hover-zone"}),s=r.createDiv({cls:"hover-color-picker"}),n=s.createDiv({cls:"hover-color-options"}),o=[this.plugin.settings.customColors.yellow,this.plugin.settings.customColors.red,this.plugin.settings.customColors.teal,this.plugin.settings.customColors.blue,this.plugin.settings.customColors.green],l=(this.plugin.settings.extraColors||[]).map(d=>{var u;return(u=d==null?void 0:d.ui)!=null?u:d==null?void 0:d.hex}).filter(Boolean);(l.length?l:o).forEach((d,u)=>{n.createDiv({cls:"hover-color-option",attr:{"data-color":d,style:`--option-index: ${u}`}}).addEventListener("click",p=>{var C;p.stopPropagation(),(C=e.onColorChange)==null||C.call(e,t,d)})});let h,a=()=>{h=window.setTimeout(()=>{s.classList.add("visible")},500)},g=()=>{window.clearTimeout(h),s.classList.remove("visible")};i.addEventListener("mouseenter",a),i.addEventListener("mouseleave",g),s.addEventListener("mouseenter",()=>{window.clearTimeout(h),s.classList.add("visible")}),s.addEventListener("mouseleave",g)}_slugifyName(r){return(r||"").toLowerCase().replace(/[^a-z0-9]+/g,"")}resolveLabelFromHighlight(r){var s,n,o,l,c;let t=this.plugin.settings,e=r.markClassSlug||"",i={};(s=t.customColorNames)!=null&&s.yellow&&(i[this._slugifyName(t.customColorNames.yellow)]=t.customColorNames.yellow),(n=t.customColorNames)!=null&&n.red&&(i[this._slugifyName(t.customColorNames.red)]=t.customColorNames.red),(o=t.customColorNames)!=null&&o.teal&&(i[this._slugifyName(t.customColorNames.teal)]=t.customColorNames.teal),(l=t.customColorNames)!=null&&l.blue&&(i[this._slugifyName(t.customColorNames.blue)]=t.customColorNames.blue),(c=t.customColorNames)!=null&&c.green&&(i[this._slugifyName(t.customColorNames.green)]=t.customColorNames.green);for(let h of t.extraColors||[])h!=null&&h.name&&(i[this._slugifyName(h.name)]=h.name);return e&&i[e]?i[e]:""}};var ht=class{isHtmlHighlight(r){return!r.isNativeComment&&!!r.color}getHtmlHighlightPatterns(r){let t=this.escapeRegex(r.text),e=[];return e.push({pattern:`<span\\s+style=["'][^"']*background:\\s*[^;"']+[^"']*["'][^>]*>${t}<\\/span>`}),e.push({pattern:`<font\\s+color=["'][^"']+["'][^>]*>${t}<\\/font>`}),e.push({pattern:`<mark[^>]*>${t}<\\/mark>`}),e}extractInlineFootnotes(r,t){let e=[],i=r.substring(t),s=/(\s*\^\[([^\]]+)\])/g,n;for(;(n=s.exec(i))!==null&&(n.index===0||this.isValidFootnotePosition(i,n.index));)e.push({content:n[2],startIndex:t+n.index,endIndex:t+n.index+n[0].length});return e}isValidFootnotePosition(r,t){let e=r.substring(0,t);return/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(e)}insertInlineFootnote(r,t,e){let i=r.getValue(),s=this.escapeRegex(t.text),n=null,o=1/0;if(t.isNativeComment){let u=`%%${s}%%`,m=new RegExp(u,"g"),p;for(;(p=m.exec(i))!==null;){let C=Math.abs(p.index-t.startOffset);C<o&&(o=C,n={index:p.index,length:p[0].length})}}else if(this.isHtmlHighlight(t)){let u=this.getHtmlHighlightPatterns(t);for(let{pattern:m}of u){let p=new RegExp(m,"gi"),C;for(;(C=p.exec(i))!==null;){let w=Math.abs(C.index-t.startOffset);w<o&&(o=w,n={index:C.index,length:C[0].length})}}}else{let u=`==${s}==`,m=new RegExp(u,"g"),p;for(;(p=m.exec(i))!==null;){let C=Math.abs(p.index-t.startOffset);C<o&&(o=C,n={index:p.index,length:p[0].length})}}if(!n)return!1;let l=n.index+n.length,c=i.substring(l),h=c.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),a=h?h[0].length:0;if(a>0&&c.length>a){let u=c.substring(a);if(!u.match(/^\S/)){let m=u.match(/^(\s+)/);if(m){let p=m[1];u.substring(m[0].length).length===0&&(a+=m[0].length)}}}else if(a>0){let u=c.substring(a).match(/^\s+/);u&&(a+=u[0].length)}l+=a;let g=`^[${e}]`,d=r.offsetToPos(l);if(r.replaceRange(g,d),e.length>0){let u=r.offsetToPos(l+g.indexOf(e)),m=r.offsetToPos(l+g.indexOf(e)+e.length);r.setSelection(u,m)}else{let u=r.offsetToPos(l+g.length-1);r.setCursor(u)}return r.focus(),!0}escapeRegex(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var st=class{static parseQuery(r){if(!r.trim())return{ast:null};try{return this.tokens=this.tokenize(r),this.position=0,this.depth=0,{ast:this.parseExpression()}}catch(t){return console.warn("Search parsing error:",t),{ast:null}}}static tokenize(r){let t=[],e=0,i=0,s=r.length*2;for(;e<r.length&&i<s;){if(i++,/\s/.test(r[e])){e++;continue}if(r[e]==="("){t.push({type:"LPAREN",value:"("}),e++;continue}if(r[e]===")"){t.push({type:"RPAREN",value:")"}),e++;continue}if(r.substr(e,3)==="AND"&&(e+3>=r.length||/\s/.test(r[e+3]))){t.push({type:"AND",value:"AND"}),e+=3;continue}if(r.substr(e,2)==="OR"&&(e+2>=r.length||/\s/.test(r[e+2]))){t.push({type:"OR",value:"OR"}),e+=2;continue}if(r[e]==='"'){e++;let c=e;for(;e<r.length&&r[e]!=='"';)e++;if(e<r.length){let h=r.substring(c,e);h.trim()&&t.push({type:"TEXT",value:h}),e++}else{let h=r.substring(c-1);t.push({type:"TEXT",value:h}),e=r.length}continue}let n=r.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_/-]+)/);if(n){let c=n[1]==="-",h=n[2],a=n[3];t.push({type:"FILTER",value:a,filterType:h==="#"?"tag":"collection",exclude:c}),e+=n[0].length;continue}let o=e,l="";for(;e<r.length&&!(r.substr(e,3)==="AND"&&(e+3>=r.length||/\s/.test(r[e+3]))||r.substr(e,2)==="OR"&&(e+2>=r.length||/\s/.test(r[e+2]))||r[e]==="("||r[e]===")"||r[e]==='"'||r.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_-]+)/));)l+=r[e],e++;l=l.trim(),l?t.push({type:"TEXT",value:l}):e===o&&e++}return t}static parseExpression(){var e;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.parseAndExpression(),t=0;for(;((e=this.current())==null?void 0:e.type)==="OR"&&t<100;){this.advance();let i=this.parseAndExpression();if(!i)break;r={type:"operator",operator:"OR",left:r,right:i},t++}return this.depth--,r}static parseAndExpression(){var e,i;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.parsePrimary(),t=0;for(;(((e=this.current())==null?void 0:e.type)==="AND"||this.isImplicitAnd())&&t<100;){((i=this.current())==null?void 0:i.type)==="AND"&&this.advance();let s=this.parsePrimary();if(!s)break;r={type:"operator",operator:"AND",left:r,right:s},t++}return this.depth--,r}static parsePrimary(){var t;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.current();if(!r)return this.depth--,null;if(r.type==="LPAREN"){this.advance();let e=this.parseExpression();return((t=this.current())==null?void 0:t.type)==="RPAREN"&&this.advance(),this.depth--,e}if(r.type==="FILTER"){this.advance();let e={type:"filter",filterType:r.filterType,value:r.value,exclude:r.exclude||!1};return this.depth--,e}if(r.type==="TEXT"){this.advance();let e={type:"text",value:r.value};return this.depth--,e}return this.depth--,null}static current(){return this.tokens[this.position]}static advance(){this.position++}static isImplicitAnd(){let r=this.current();return!!r&&(r.type==="FILTER"||r.type==="TEXT"||r.type==="LPAREN")}static getTokensFromQuery(r){let t=[],e=this.parseQuery(r);return e.ast&&this.extractTokensFromAST(e.ast,t),t}static extractTokensFromAST(r,t){if(r.type==="filter"){let e=r;t.push({type:e.filterType,value:e.value,exclude:e.exclude})}else if(r.type==="text"){let e=r;t.push({type:"text",value:e.value,exclude:!1})}else if(r.type==="operator"){let e=r;this.extractTokensFromAST(e.left,t),this.extractTokensFromAST(e.right,t)}}};st.tokens=[],st.position=0,st.depth=0,st.MAX_DEPTH=50;var vt=class{constructor(r,t,e,i){this.currentSuggestions=[];this.selectedIndex=-1;this.input=r,this.container=t,this.onSearchChange=e,this.suggestions=i,this.createDropdown(),this.createPreview(),this.setupEventListeners()}createDropdown(){this.dropdown=this.container.createDiv({cls:"simple-search-dropdown"}),this.dropdown.classList.add("hidden")}createPreview(){this.previewElement=this.container.createDiv({cls:"simple-search-preview"}),this.previewElement.classList.add("hidden")}setupEventListeners(){this.input.addEventListener("input",()=>{this.handleInput()}),this.input.addEventListener("keydown",r=>{this.handleKeydown(r)}),this.input.addEventListener("focus",()=>{this.updateAutocomplete()}),this.input.addEventListener("blur",()=>{window.setTimeout(()=>this.hideDropdown(),150)})}handleInput(){let r=this.input.value,t=st.parseQuery(r);this.updatePreview(t),this.updateAutocomplete(),this.onSearchChange(r,t)}handleKeydown(r){if(!this.dropdown.classList.contains("hidden"))switch(r.key){case"ArrowDown":r.preventDefault(),this.selectNext();break;case"ArrowUp":r.preventDefault(),this.selectPrevious();break;case"Enter":r.preventDefault(),this.applySuggestion();break;case"Escape":r.preventDefault(),this.hideDropdown();break}}updateAutocomplete(){let r=this.input.value,t=this.input.selectionStart||0,e=r.substring(0,t),i=e.match(/-?#([a-zA-Z0-9_/-]*)$/),s=e.match(/-?@([a-zA-Z0-9_-]*)$/);i?this.showSuggestions("tag",i[1],i[0].startsWith("-")):s?this.showSuggestions("collection",s[1],s[0].startsWith("-")):this.hideDropdown()}showSuggestions(r,t,e){let i=r==="tag"?this.suggestions.tags:this.suggestions.collections;if(this.currentSuggestions=i.filter(s=>s.toLowerCase().includes(t.toLowerCase())).slice(0,8),this.dropdown.empty(),this.selectedIndex=-1,this.currentSuggestions.length===0){this.hideDropdown();return}this.currentSuggestions.forEach((s,n)=>{let o=this.dropdown.createDiv({cls:"simple-search-suggestion"}),l=o.createSpan({cls:"simple-search-suggestion-icon",text:r==="tag"?"#":"@"});e&&l.classList.add("exclude");let c=this.formatNestedTag(s);o.createSpan({cls:"simple-search-suggestion-text",text:c}),o.addEventListener("click",()=>{this.selectedIndex=n,this.applySuggestion()}),o.addEventListener("mouseenter",()=>{this.setSelected(n)})}),this.dropdown.classList.remove("hidden")}selectNext(){this.currentSuggestions.length!==0&&this.setSelected((this.selectedIndex+1)%this.currentSuggestions.length)}selectPrevious(){this.currentSuggestions.length!==0&&this.setSelected(this.selectedIndex<=0?this.currentSuggestions.length-1:this.selectedIndex-1)}setSelected(r){let t=this.dropdown.querySelectorAll(".simple-search-suggestion");t.forEach(e=>e.classList.remove("selected")),r>=0&&r<t.length&&(t[r].classList.add("selected"),this.selectedIndex=r)}applySuggestion(){if(this.selectedIndex<0||this.selectedIndex>=this.currentSuggestions.length)return;let r=this.currentSuggestions[this.selectedIndex],t=this.input.value,e=this.input.selectionStart||0,i=t.substring(0,e),s=t.substring(e),n=i.match(/-?#([a-zA-Z0-9_-]*)$/),o=i.match(/-?@([a-zA-Z0-9_-]*)$/),l,c;if(n){let a=(n[0].startsWith("-")?"-#":"#")+r+" ";l=i.replace(/-?#[a-zA-Z0-9_/-]*$/,a)+s,c=i.replace(/-?#[a-zA-Z0-9_/-]*$/,a).length}else if(o){let a=(o[0].startsWith("-")?"-@":"@")+r+" ";l=i.replace(/-?@[a-zA-Z0-9_-]*$/,a)+s,c=i.replace(/-?@[a-zA-Z0-9_-]*$/,a).length}else return;this.input.value=l,this.input.setSelectionRange(c,c),this.hideDropdown(),this.handleInput()}hideDropdown(){this.dropdown.classList.add("hidden"),this.selectedIndex=-1}updatePreview(r){if(this.previewElement.empty(),!this.input.value.trim()){this.previewElement.classList.add("hidden");return}if(this.previewElement.classList.remove("hidden"),!r.ast){this.previewElement.createSpan({cls:"simple-search-preview-text",text:"Use #tag @collection (-# to exclude)"});return}let t=r.ast?this.generateDescription(r.ast):"Invalid search query";this.previewElement.createSpan({cls:"simple-search-preview-label",text:"Matching: "}),this.previewElement.createSpan({cls:"simple-search-preview-logic",text:t})}generateDescription(r){return r?this.generateNodeDescription(r):"Invalid"}generateNodeDescription(r){if(r.type==="filter"){let t=r,e=t.exclude?"-":"",i=t.filterType==="tag"?"#":"@";return`${e}${i}${t.value}`}else{if(r.type==="text")return`"${r.value}"`;if(r.type==="operator"){let t=r,e=this.generateNodeDescription(t.left),i=this.generateNodeDescription(t.right);return`${e} ${t.operator} ${i}`}}return""}updateSuggestions(r){this.suggestions=r,this.updateAutocomplete()}clear(){this.input.value="",this.hideDropdown(),this.handleInput()}setValue(r){this.input.value=r,this.handleInput()}formatNestedTag(r){return r}};var wt=class{constructor(){this.anchorId=null;this.anchorLocalOffset=0;this.pinnedToBottom=!1}capture(r,t="[data-highlight-id]"){var c;let{scrollTop:e,clientHeight:i,scrollHeight:s}=r;if(this.pinnedToBottom=e+i>=s-1,this.pinnedToBottom){this.anchorId=null;return}let n=e+i/2,o=Array.from(r.querySelectorAll(t)),l=null;for(let h of o){let a=h.offsetTop,g=a+h.offsetHeight;if(a<=n&&n<g){l=h;break}}!l&&o.length&&(l=(c=o.find(h=>h.offsetTop+h.offsetHeight<=n))!=null?c:o[0]),l?(this.anchorId=l.getAttribute("data-highlight-id"),this.anchorLocalOffset=n-l.offsetTop):this.anchorId=null}restore(r,t="[data-highlight-id]"){requestAnimationFrame(()=>{if(this.pinnedToBottom){r.scrollTop=r.scrollHeight-r.clientHeight;return}if(!this.anchorId)return;let e=`${t}[data-highlight-id="${CSS.escape(this.anchorId)}"]`,i=r.querySelector(e);if(!i)return;let s=i.offsetTop+this.anchorLocalOffset,n=Math.max(0,s-r.clientHeight/2);r.scrollTop=n})}};var Rt={none:0,content:1,full:2},yt=class{constructor(){this.pending="none";this.scheduled=!1;this.isRendering=!1}request(r,t){Rt[r]>Rt[this.pending]&&(this.pending=r),!this.scheduled&&(this.scheduled=!0,queueMicrotask(()=>{if(this.isRendering)return;this.isRendering=!0;let e=this.pending==="none"?"content":this.pending;this.pending="none",this.scheduled=!1;try{t(e)}finally{this.isRendering=!1}}))}get busy(){return this.isRendering}};var Zt="highlights-sidebar",bt=class extends x.ItemView{constructor(t,e){super(t);this.restorer=new wt;this.scheduler=new yt;this.highlightCommentsVisible=new Map;this.groupingMode="none";this.commentsExpanded=!1;this.selectedTags=new Set;this.selectedCollections=new Set;this.viewMode="current";this.currentCollectionId=null;this.preservedScrollTop=0;this.isHighlightFocusing=!1;this.currentPage=0;this.itemsPerPage=100;this.totalHighlights=[];this.isPreservingPagination=!1;this.currentGroupPage=0;this.totalGroups=[];this.isColorChanging=!1;this.searchExpanded=!1;this.currentSearchTokens=[];this.currentParsedSearch={ast:null};this.dropdownManager=new ft;this.savedScrollPosition=0;this.showNativeComments=!0;this.plugin=e,this.highlightRenderer=new Ct(e),this.groupingMode=e.settings.groupingMode||"none",this.showNativeComments=this.plugin.app.loadLocalStorage("sidebar-highlights-show-native-comments")!=="false"}setPreservePagination(t){this.isPreservingPagination=t}getViewType(){return Zt}getDisplayText(){return"Highlights"}getIcon(){return"highlighter"}async onOpen(){var n;if(this.contentEl.empty(),this.contentEl.classList.add("highlights-sidebar-content"),this.plugin.settings.showToolbar){let o=this.contentEl.createDiv({cls:"highlights-search-container"}),l=o.createEl("button",{cls:"highlights-group-button"});this.searchButton=l,(0,x.setIcon)(l,"search"),(0,x.setTooltip)(l,"Search"),l.addEventListener("click",()=>{this.toggleSearch()});let c=o.createEl("button",{cls:"highlights-group-button"});(0,x.setIcon)(c,"group"),(0,x.setTooltip)(c,"Group highlights"),this.updateGroupButtonState(c),c.addEventListener("click",p=>{let C=new x.Menu;C.addItem(w=>{w.setTitle("None").setIcon("list").setChecked(this.groupingMode==="none").onClick(()=>{this.groupingMode="none",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addSeparator(),C.addItem(w=>{w.setTitle("Color").setIcon("palette").setChecked(this.groupingMode==="color").onClick(()=>{this.groupingMode="color",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addSeparator(),C.addItem(w=>{w.setTitle("Highlight comments \u2191").setIcon("sort-asc").setChecked(this.groupingMode==="comments-asc").onClick(()=>{this.groupingMode="comments-asc",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addItem(w=>{w.setTitle("Highlight comments \u2193").setIcon("sort-desc").setChecked(this.groupingMode==="comments-desc").onClick(()=>{this.groupingMode="comments-desc",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addSeparator(),C.addItem(w=>{w.setTitle("Date created \u2191").setIcon("calendar").setChecked(this.groupingMode==="date-created-asc").onClick(()=>{this.groupingMode="date-created-asc",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addItem(w=>{w.setTitle("Date created \u2193").setIcon("calendar").setChecked(this.groupingMode==="date-created-desc").onClick(()=>{this.groupingMode="date-created-desc",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addSeparator(),C.addItem(w=>{w.setTitle("Parent").setIcon("folder").setChecked(this.groupingMode==="parent").onClick(()=>{this.groupingMode="parent",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addItem(w=>{w.setTitle("Collection").setIcon("folder-open").setChecked(this.groupingMode==="collection").onClick(()=>{this.groupingMode="collection",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.addItem(w=>{w.setTitle("Filename").setIcon("file-text").setChecked(this.groupingMode==="filename").onClick(()=>{this.groupingMode="filename",this.updateGroupButtonState(c),this.saveGroupingModeToSettings(),this.renderContent()})}),C.showAtMouseEvent(p)});let h=o.createEl("button",{cls:"highlights-group-button"});(0,x.setTooltip)(h,"Toggle native comments"),this.updateNativeCommentsToggleState(h),h.addEventListener("click",()=>{this.toggleNativeCommentsVisibility(),this.updateNativeCommentsToggleState(h),this.renderContent()});let a=o.createEl("button",{cls:"highlights-group-button"});(0,x.setTooltip)(a,"Toggle highlight comments"),this.commentsToggleButton=a,this.updateCommentsToggleIcon(a),a.addEventListener("click",()=>{this.toggleAllComments(),this.updateCommentsToggleIcon(a),this.renderContent()});let g=o.createEl("button",{cls:"highlights-group-button"});(0,x.setTooltip)(g,"Revert highlight colors"),(0,x.setIcon)(g,"rotate-ccw"),g.addEventListener("click",()=>{this.resetAllColors()});let d=o.createEl("button",{cls:"highlights-group-button highlights-tag-filter-button"});(0,x.setTooltip)(d,"Filter"),(0,x.setIcon)(d,"list-filter"),d.addEventListener("click",p=>{this.showTagFilterMenu(p)});let u=o.createEl("button",{cls:"highlights-group-button"});(0,x.setTooltip)(u,"Collection Navigation"),this.updateCollectionNavButton(u),u.addEventListener("click",()=>{this.viewMode==="collections"&&this.currentCollectionId?(this.currentCollectionId=null,this.renderContent()):this.showNewCollectionDialog()});let m=this.contentEl.createDiv({cls:"highlights-search-input-container hidden"});this.searchInputEl=m.createEl("input",{type:"text",placeholder:"Search highlights, use #tag @collection (-# to exclude)...",cls:"highlights-search-input"}),this.simpleSearchManager=new vt(this.searchInputEl,m,(p,C)=>this.handleSearchInput(p,C),{tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}let t=this.contentEl.createDiv({cls:"highlights-tabs-container"}),e=t.createEl("button",{cls:"highlights-tab active"});(0,x.setIcon)(e,"file-text"),(0,x.setTooltip)(e,"Current note");let i=t.createEl("button",{cls:"highlights-tab"});(0,x.setIcon)(i,"files"),(0,x.setTooltip)(i,"All notes");let s=t.createEl("button",{cls:"highlights-tab"});(0,x.setIcon)(s,"folder-open"),(0,x.setTooltip)(s,"Collections"),e.addEventListener("click",()=>{this.viewMode!=="current"&&(e.classList.add("active"),i.classList.remove("active"),s.classList.remove("active"),this.viewMode="current",this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),i.addEventListener("click",()=>{this.viewMode!=="all"&&(i.classList.add("active"),e.classList.remove("active"),s.classList.remove("active"),this.viewMode="all",this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),s.addEventListener("click",()=>{this.viewMode!=="collections"&&(s.classList.add("active"),e.classList.remove("active"),i.classList.remove("active"),this.viewMode="collections",this.currentCollectionId=null,this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),this.contentAreaEl=this.contentEl.createDiv({cls:"highlights-list-area"}),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});try{(n=this.uiVarObserver)==null||n.disconnect(),this.uiVarObserver=new MutationObserver(o=>{var l;for(let c of o)(l=c.addedNodes)==null||l.forEach(h=>{var a,g;h instanceof HTMLElement&&(h.hasAttribute&&h.hasAttribute("data-highlight-id")&&this.applyUiColorToElement(h),(g=(a=h.querySelectorAll)==null?void 0:a.call(h,"[data-highlight-id]"))==null||g.forEach(d=>{this.applyUiColorToElement(d)}))})}),this.uiVarObserver.observe(this.listContainerEl,{childList:!0,subtree:!0})}catch(o){}this.renderContent()}async onClose(){var t;try{(t=this.uiVarObserver)==null||t.disconnect()}catch(e){}this.dropdownManager.cleanup(),this.highlightCommentsVisible.clear(),this.selectedTags.clear()}navigateToCollection(t){if(!this.plugin.collectionsManager.getCollection(t)){new x.Notice("Collection not found");return}this.viewMode="collections",this.currentCollectionId=t;let i=this.contentEl.querySelectorAll(".highlights-tab");if(i.length>=3){let s=i[0],n=i[1],o=i[2];s.classList.remove("active"),n.classList.remove("active"),o.classList.remove("active"),o.classList.add("active")}this.selectedTags.clear(),this.renderContent()}refresh(){this.selectedTags.clear();let t=this.viewMode,e=this.currentCollectionId,i=this.isHighlightFocusing||this.isColorChanging,s=this.preservedScrollTop;this.scheduler.request("full",n=>{!i&&this.contentAreaEl&&this.restorer.capture(this.contentAreaEl,"[data-highlight-id]"),n==="full"?this.onOpen():this.renderContent(),this.viewMode=t,this.currentCollectionId=e,this.updateTabStates(),this.restoreSelectedHighlight(),i?requestAnimationFrame(()=>{this.contentAreaEl&&(this.contentAreaEl.scrollTop=s)}):this.contentAreaEl&&this.restorer.restore(this.contentAreaEl,"[data-highlight-id]")})}updateTabStates(){let t=this.contentEl.querySelectorAll(".highlights-tab");if(t.length>=3){let e=t[0],i=t[1],s=t[2];switch(e.classList.remove("active"),i.classList.remove("active"),s.classList.remove("active"),this.viewMode){case"current":e.classList.add("active");break;case"all":i.classList.add("active");break;case"collections":s.classList.add("active");break}}}captureScrollPosition(){this.contentAreaEl&&(this.savedScrollPosition=this.contentAreaEl.scrollTop)}restoreScrollPosition(){this.contentAreaEl&&!this.isHighlightFocusing&&!this.isColorChanging&&requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.savedScrollPosition})}restoreSelectedHighlight(){this.plugin.selectedHighlightId&&requestAnimationFrame(()=>{this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(i=>{i.classList.remove("selected","highlight-selected"),i.style.removeProperty("border-left-color"),i.style.removeProperty("box-shadow")});let e=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(e){e.classList.add("selected");let i=this.plugin.selectedHighlightId?this.getHighlightById(this.plugin.selectedHighlightId):null;i&&(e.classList.add("highlight-selected"),this.applyHighlightColorStyling(e,i))}})}applyHighlightColorStyling(t,e){let i=e.color||this.plugin.settings.highlightColor,s=this.getUiColorFromDoc(i),n=this.toRgbTupleString(s);t.style.borderLeftColor=s,t.style.setProperty("--hl-ui-rgb",n),t.style.setProperty("--text-highlight-bg-rgb",n)}updateContent(){this.scheduler.request("content",t=>{this.contentAreaEl&&this.restorer.capture(this.contentAreaEl,"[data-highlight-id]"),t==="full"?this.onOpen():this.renderContent(),this.contentAreaEl&&this.restorer.restore(this.contentAreaEl,"[data-highlight-id]")}),this.applyUiColorToAllCards()}updateItem(t){var l;let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`);if(!e)return;let i=this.getHighlightById(t);if(!i){e.remove();return}let s=document.createElement("div"),n=this.viewMode==="all";this.createHighlightItem(s,i,this.getSearchTerm(),n);let o=s.firstElementChild;o&&((l=e.parentNode)==null||l.replaceChild(o,e),this.plugin.selectedHighlightId===t&&(o.classList.add("selected"),o.classList.add("highlight-selected"),this.applyHighlightColorStyling(o,i)))}getSearchTerm(){let t=this.containerEl.querySelector(".highlights-search-input");return(t==null?void 0:t.value)||""}renderContent(){this.captureScrollPosition(),this.viewMode==="collections"?this.currentCollectionId?(this.enableSearchAndToolbar(),this.renderCollectionDetailView(this.currentCollectionId)):(this.disableSearchAndToolbar(),this.renderCollectionsView()):(this.enableSearchAndToolbar(),this.renderFilteredList());let t=this.contentEl.querySelector(".highlights-search-container button:last-of-type");t&&this.updateCollectionNavButton(t),this.restoreScrollPosition(),this.applyUiColorToAllCards()}renderCollectionsView(){this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list collections-container"});let t=this.plugin.collectionsManager.getAllCollections();t.length===0?this.renderEmptyCollectionsState(this.listContainerEl):this.renderCollectionsGrid(this.listContainerEl,t),this.restoreScrollPosition()}renderEmptyCollectionsState(t){t.createEl("p",{text:"No collections."})}renderCollectionsGrid(t,e){let i=t.createDiv({cls:"collections-grid"});e.forEach(s=>{let n=i.createDiv({cls:"collection-card"});n.setAttribute("data-collection-id",s.id);let o=n.createDiv({cls:"collection-menu-btn"});(0,x.setIcon)(o,"ellipsis-vertical"),o.addEventListener("click",C=>{C.stopPropagation(),this.showCollectionMenu(C,s)});let l=n.createDiv({cls:"collection-name"});l.textContent=s.name;let c=n.createDiv({cls:"collection-description"});s.description&&s.description.trim()?c.textContent=s.description:(c.textContent="No description",c.classList.add("collection-description-empty"));let h=n.createDiv({cls:"collection-stats"}),a=this.plugin.collectionsManager.getCollectionStats(s.id),g=h.createEl("small",{cls:"collection-info-line"}),d=g.createDiv({cls:"highlight-line-info"}),u=d.createDiv({cls:"line-icon"});if((0,x.setIcon)(u,"highlighter"),d.createSpan({text:`${a.highlightCount}`}),this.showNativeComments){let C=g.createDiv({cls:"highlight-line-info"}),w=C.createDiv({cls:"line-icon"});(0,x.setIcon)(w,"captions"),C.createSpan({text:`${a.nativeCommentsCount}`})}let m=g.createDiv({cls:"highlight-line-info"}),p=m.createDiv({cls:"line-icon"});(0,x.setIcon)(p,"file-text"),m.createSpan({text:`${a.fileCount}`}),n.addEventListener("click",()=>{this.currentCollectionId=s.id,this.renderContent()})})}renderCollectionDetailView(t){this.captureScrollPosition();let e=this.plugin.collectionsManager.getCollection(t);if(!e){new x.Notice("Collection not found"),this.currentCollectionId=null,this.renderContent();return}this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let i=this.plugin.collectionsManager.getHighlightsInCollection(t);i.length===0?this.renderEmptyCollectionState(this.listContainerEl,e):this.renderCollectionHighlights(i),this.restoreScrollPosition()}renderEmptyCollectionState(t,e){t.createEl("p",{text:"No highlights in collection."})}renderCollectionHighlights(t){var s;let e=((s=this.searchInputEl)==null?void 0:s.value.toLowerCase().trim())||"",i=this.applyAllFilters(t);if(i.length===0){let n=e?"No matching highlights in collection.":"No highlights in collection.";this.listContainerEl.createEl("p",{text:n});return}this.groupingMode==="none"?i.sort((o,l)=>o.filePath!==l.filePath?o.filePath.localeCompare(l.filePath):o.startOffset-l.startOffset).forEach(o=>{this.createHighlightItem(this.listContainerEl,o,e,!0)}):this.renderGroupedHighlights(i,e,!0),this.applyUiColorToAllCards()}renderFilteredList(){if(!this.contentAreaEl||!this.listContainerEl)return;this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let t=this.searchInputEl?this.searchInputEl.value.toLowerCase().trim():"";this.listContainerEl.empty();let e;if(this.viewMode==="current"){if(!this.plugin.app.workspace.getActiveFile()){this.listContainerEl.createEl("p",{text:"No file open."}),this.restoreScrollPosition(),this.showTagActive();return}e=this.plugin.getCurrentFileHighlights()}else if(this.viewMode==="all"){e=[];for(let[s,n]of this.plugin.highlights)e.push(...n)}else return;let i=this.applyAllFilters(e);if(i.length===0){let s;if(this.viewMode==="current"){let n=this.plugin.app.workspace.getActiveFile();n&&n.extension==="pdf"?s="PDF highlights are not supported.":s=t?"No matching highlights.":"No highlights in this file."}else s=t?"No matching highlights across all files.":"No highlights found across all files.";this.listContainerEl.createEl("p",{text:s})}else if(this.groupingMode==="none"){let s=i.sort((n,o)=>n.filePath!==o.filePath?n.filePath.localeCompare(o.filePath):n.startOffset-o.startOffset);this.viewMode==="all"?this.renderHighlightsWithPagination(s,t):s.forEach(n=>{this.createHighlightItem(this.listContainerEl,n,t,!1)})}else this.viewMode==="all"?this.renderGroupedHighlightsWithPagination(i,t):this.renderGroupedHighlights(i,t,!1);this.showTagActive(),this.restoreScrollPosition()}renderHighlightsWithPagination(t,e){this.totalHighlights=t,this.isPreservingPagination||(this.currentPage=0);let i=Math.max(0,Math.ceil(t.length/this.itemsPerPage)-1);this.currentPage>i&&(this.currentPage=i),this.renderCurrentPage(e),this.renderPaginationControls(),this.isPreservingPagination=!1}renderCurrentPage(t){let e=this.currentPage*this.itemsPerPage,i=Math.min(e+this.itemsPerPage,this.totalHighlights.length),s=this.totalHighlights.slice(e,i);this.listContainerEl.empty(),s.forEach(n=>{this.createHighlightItem(this.listContainerEl,n,t,!0)}),this.applyUiColorToAllCards()}renderPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=Math.ceil(this.totalHighlights.length/this.itemsPerPage);if(e<=1)return;let i=this.listContainerEl.createDiv({cls:"pagination-controls"}),s=i.createEl("button",{cls:"clickable-icon"});s.disabled=this.currentPage===0,(0,x.setIcon)(s,"chevron-left"),s.addEventListener("click",()=>{this.currentPage>0&&(this.currentPage--,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let n=i.createSpan({text:`${this.currentPage+1}/${e}`,cls:"pagination-info pagination-info-compact"}),o=i.createEl("button",{cls:"clickable-icon"});o.disabled=this.currentPage>=e-1,(0,x.setIcon)(o,"chevron-right"),o.addEventListener("click",()=>{this.currentPage<e-1&&(this.currentPage++,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}renderGroupedHighlightsWithPagination(t,e){let i=new Map,s=new Map;t.forEach(c=>{var a;let h;if(this.groupingMode==="color"){let g=c.color||this.plugin.settings.highlightColor;h=g,s.set(h,g)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let g=c.isNativeComment?0:((a=c.footnoteContents)==null?void 0:a.filter(d=>d.trim()!=="").length)||0;h=g===0?"No Comments":g===1?"1 Comment":`${g} Comments`}else if(this.groupingMode==="parent"){let g=c.filePath.split("/");g.length>1?h=g[g.length-2]:h="Root"}else if(this.groupingMode==="collection"){let g=this.plugin.collectionsManager.getAllCollections().filter(d=>d.highlightIds.includes(c.id));g.length===0?h="No Collections":g.length===1?h=g[0].name:h=g.map(d=>d.name).sort().join(", ")}else if(this.groupingMode==="filename")h=(c.filePath.split("/").pop()||c.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(c.createdAt){let g=new Date(c.createdAt),d=g.getFullYear(),u=String(g.getMonth()+1).padStart(2,"0"),m=String(g.getDate()).padStart(2,"0");h=`${d}-${u}-${m}`}else h="No Date";else h="Default";i.has(h)||i.set(h,[]),i.get(h).push(c)});let n=Array.from(i.entries()).map(([c,h])=>{let a;return this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?a=h.sort((g,d)=>{let u=g.createdAt||0,m=d.createdAt||0;return this.groupingMode==="date-created-asc"?u-m:m-u}):a=h.sort((g,d)=>g.startOffset-d.startOffset),[c,a]}).sort(([c],[h])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(c==="No Comments"&&h==="No Comments")return 0;if(c==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(h==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let a=parseInt(c.split(" ")[0])||0,g=parseInt(h.split(" ")[0])||0;return this.groupingMode==="comments-asc"?a-g:g-a}else{if(this.groupingMode==="tag")return c==="No Tags"&&h==="No Tags"?0:c==="No Tags"?1:h==="No Tags"?-1:c.localeCompare(h);if(this.groupingMode==="parent")return c==="Root"&&h==="Root"?0:c==="Root"?-1:h==="Root"?1:c.localeCompare(h);if(this.groupingMode==="collection")return c==="No Collections"&&h==="No Collections"?0:c==="No Collections"?1:h==="No Collections"?-1:c.localeCompare(h);if(this.groupingMode==="filename")return c.localeCompare(h);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(c==="No Date"&&h==="No Date")return 0;if(c==="No Date")return 1;if(h==="No Date")return-1;let a=new Date(c),g=new Date(h);return this.groupingMode==="date-created-asc"?a.getTime()-g.getTime():g.getTime()-a.getTime()}}return c.localeCompare(h)});this.totalGroups=n,this.isPreservingPagination||(this.currentGroupPage=0);let o=n.reduce((c,[,h])=>c+h.length,0),l=Math.max(0,Math.ceil(o/this.itemsPerPage)-1);this.currentGroupPage>l&&(this.currentGroupPage=l),this.renderCurrentGroupPage(e,s),this.renderGroupPaginationControls(),this.isPreservingPagination=!1}renderCurrentGroupPage(t,e){let i=this.currentGroupPage*this.itemsPerPage,s=i+this.itemsPerPage;this.listContainerEl.empty();let n=0,o=0;for(let[l,c]of this.totalGroups){let h=c.length;if(n+h>i&&n<s){let a=Math.max(0,i-n),g=Math.min(h,s-n),d=c.slice(a,g);d.length>0&&(this.renderGroupHeader(l,c,e),d.forEach(u=>{this.createHighlightItem(this.listContainerEl,u,t,!0),o++}))}if(n+=h,n>=s)break}}renderGroupHeader(t,e,i){let s=this.listContainerEl.createDiv({cls:"highlight-group-header"}),n=s.createSpan();if(this.groupingMode==="color"&&(i!=null&&i.has(t))){let w=i.get(t),S=n.createDiv({cls:"group-color-square",attr:{"data-color":w}});S.style.backgroundColor=w}if(this.groupingMode==="tag"){let w=n.createDiv({cls:"group-tag-icon"});(0,x.setIcon)(w,"tag")}let o=n.createSpan();o.textContent=this.groupingMode==="color"?this.getColorName(t):t;let c=s.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),a=new Set(e.map(w=>w.filePath)).size,g=e.filter(w=>w.isNativeComment).length,d=e.filter(w=>!w.isNativeComment).length,u=c.createDiv({cls:"highlight-line-info"}),m=u.createDiv({cls:"line-icon"});if((0,x.setIcon)(m,"highlighter"),u.createSpan({text:`${d}`}),this.showNativeComments){let w=c.createDiv({cls:"highlight-line-info"}),S=w.createDiv({cls:"line-icon"});(0,x.setIcon)(S,"captions"),w.createSpan({text:`${g}`})}let p=c.createDiv({cls:"highlight-line-info"}),C=p.createDiv({cls:"line-icon"});(0,x.setIcon)(C,"files"),p.createSpan({text:`${a}`})}renderSingleGroup(t,e,i,s=!1,n){this.renderGroupHeader(t,e,n);let o;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?o=e.sort((l,c)=>{let h=l.createdAt||0,a=c.createdAt||0;return this.groupingMode==="date-created-asc"?h-a:a-h}):o=e.sort((l,c)=>l.startOffset-c.startOffset),o.forEach(l=>{this.createHighlightItem(this.listContainerEl,l,i,s)})}renderGroupPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=this.totalGroups.reduce((c,[,h])=>c+h.length,0),i=Math.ceil(e/this.itemsPerPage);if(i<=1)return;let s=this.listContainerEl.createDiv({cls:"pagination-controls"}),n=s.createEl("button",{cls:"clickable-icon"});n.disabled=this.currentGroupPage===0,(0,x.setIcon)(n,"chevron-left"),n.addEventListener("click",()=>{this.currentGroupPage>0&&(this.currentGroupPage--,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let o=s.createSpan({text:`${this.currentGroupPage+1}/${i}`,cls:"pagination-info pagination-info-compact"}),l=s.createEl("button",{cls:"clickable-icon"});l.disabled=this.currentGroupPage>=i-1,(0,x.setIcon)(l,"chevron-right"),l.addEventListener("click",()=>{this.currentGroupPage<i-1&&(this.currentGroupPage++,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}updateGroupButtonState(t){this.groupingMode==="none"?t.classList.remove("active"):t.classList.add("active")}saveGroupingModeToSettings(){this.plugin.settings.groupingMode=this.groupingMode,this.plugin.saveSettings()}createHighlightItem(t,e,i,s=!1){let l={searchTerm:this.currentSearchTokens.filter(h=>h.type==="text"&&!h.exclude).map(h=>h.value).join(" ")||i,showFilename:this.plugin.settings.showFilenames&&s,showTimestamp:this.plugin.settings.showTimestamps,showHighlightActions:this.plugin.settings.showHighlightActions,isCommentsVisible:this.getHighlightCommentsVisibility(e),dateFormat:this.plugin.settings.dateFormat,onCommentToggle:h=>{let a=this.highlightCommentsVisible.get(h)||!1;this.highlightCommentsVisible.set(h,!a),this.rerenderCurrentView()},onCollectionsMenu:(h,a)=>{this.showCollectionsMenu(h,a)},onColorChange:(h,a)=>{this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isColorChanging=!0,window.setTimeout(()=>{this.isColorChanging=!1},2e3),this.changeHighlightColor(h,a),this.rerenderCurrentView(),requestAnimationFrame(()=>{if(this.contentAreaEl&&this.isColorChanging&&(this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isColorChanging=!1,this.plugin.selectedHighlightId)){let g=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(g){let d=this.getHighlightById(this.plugin.selectedHighlightId);if(d){let u=d.color||this.plugin.settings.highlightColor,m=this.getUiColorFromDoc(u),p=this.toRgbTupleString(m);g.style.borderLeftColor=m,g.style.setProperty("--hl-ui-rgb",p),g.style.setProperty("--text-highlight-bg-rgb",p),g.classList.add("highlight-selected")}}}})},onHighlightClick:(h,a)=>{(async()=>{var g,d,u,m,p,C,w,S,f,D,H,I,b,M,N,F,$,A,v,y;try{let L=(g=this.app)==null?void 0:g.workspace,k=L==null?void 0:L.activeLeaf,T=k==null?void 0:k.view,P=T==null?void 0:T.file,U=((S=(w=(m=(d=T==null?void 0:T.getMode)==null?void 0:d.call(T))!=null?m:(u=T==null?void 0:T.currentMode)==null?void 0:u.type)!=null?w:(C=(p=T==null?void 0:T.getState)==null?void 0:p.call(T))==null?void 0:C.mode)!=null?S:"").toString().toLowerCase();if(P&&(U==="preview"||U==="reading")){let q=((D=(f=T==null?void 0:T.contentEl)==null?void 0:f.querySelector)==null?void 0:D.call(f,".markdown-reading-view"))||(T==null?void 0:T.contentEl)||(T==null?void 0:T.containerEl)||null,Y=(H=q==null?void 0:q.scrollTop)!=null?H:0;await k.setViewState({type:"markdown",state:{file:P.path,mode:"source"}},{focus:!0});let z=Date.now()+1500;for(;Date.now()<z;){let R=k==null?void 0:k.view,V=((A=($=(M=(I=R==null?void 0:R.getMode)==null?void 0:I.call(R))!=null?M:(b=R==null?void 0:R.currentMode)==null?void 0:b.type)!=null?$:(F=(N=R==null?void 0:R.getState)==null?void 0:N.call(R))==null?void 0:F.mode)!=null?A:"").toString().toLowerCase(),O=R==null?void 0:R.editor;if(V==="source"&&O)break;await new Promise(G=>setTimeout(G,16))}try{await this.focusHighlightInEditor(h,a)}catch(R){console.warn("[Sidebar Highlights] focusHighlightInEditor during hop failed",R)}await new Promise(R=>setTimeout(R,30)),await k.setViewState({type:"markdown",state:{file:P.path,mode:"preview"}},{focus:!0}),await new Promise(R=>setTimeout(R,50));try{let R=k==null?void 0:k.view,V=((y=(v=R==null?void 0:R.contentEl)==null?void 0:v.querySelector)==null?void 0:y.call(v,".markdown-reading-view"))||(R==null?void 0:R.contentEl)||(R==null?void 0:R.containerEl)||null;V&&typeof Y=="number"&&(V.scrollTop=Y)}catch(R){}console.log("[Sidebar Highlights] reading hop completed");return}}catch(L){console.warn("[Sidebar Highlights] reading hop wrapper error",L)}try{await this.focusHighlightInEditor(h,a)}catch(L){console.warn("[Sidebar Highlights] focusHighlightInEditor fallback failed",L)}})()},onAddMarkComment:async h=>{this.isPreservingPagination=!0,await this.focusHighlightInEditor(h),await this.addMarkAnchorToHighlightWithTargetedUpdate(h)},onAddFootnoteComment:async h=>{this.isPreservingPagination=!0,await this.focusHighlightInEditor(h),this.addFootnoteToHighlightWithTargetedUpdate(h)},onAddComment:async h=>{this.isPreservingPagination=!0,await this.focusHighlightInEditor(h),this.addFootnoteToHighlightWithTargetedUpdate(h)},onCommentClick:(h,a,g)=>{this.focusHighlightInEditor(h,g)},onTagClick:h=>{this.selectedTags.has(h)?this.selectedTags.delete(h):this.selectedTags.add(h),this.renderFilteredList(),this.showTagActive()},onColorLabelClick:(h,a,g,d)=>{var u;(u=d==null?void 0:d.stopPropagation)==null||u.call(d),this.groupingMode="color",this.saveGroupingModeToSettings(),this.renderContent(),requestAnimationFrame(()=>{var m;try{let p=((m=this.listContainerEl)==null?void 0:m.querySelectorAll(".highlight-group-header"))||[];for(let C of p){let w=C.querySelector(".collection-stats")?C.firstChild:C,S=((C==null?void 0:C.textContent)||"").trim();if(S&&S.includes(h)){C.scrollIntoView({behavior:"smooth",block:"start"});break}}}catch(p){}})},onFileNameClick:(h,a)=>{this.isPreservingPagination=!0,this.plugin.app.workspace.openLinkText(h,h,x.Keymap.isModEvent(a))}};return this.highlightRenderer.createHighlightItem(t,e,l)}rerenderCurrentView(){this.viewMode==="collections"&&this.currentCollectionId?this.renderCollectionDetailView(this.currentCollectionId):this.renderFilteredList(),this.applyUiColorToAllCards()}async addFootnoteToHighlightWithTargetedUpdate(t){let e=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);if(!e)return;let i=e.editor,s=e.file;if(!s)return;let o=i.getValue().split(`
`),l=-1,c=null;for(let h=0;h<o.length;h++){let a=o[h];if(t.isNativeComment){if(a.includes(`%%${t.text}%%`)){l=h;let g=a.indexOf(`%%${t.text}%%`)+`%%${t.text}%%`.length,d=a.substring(g),u=d.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),m=u?u[0].length:0;if(m>0&&d.length>m){let p=d.substring(m);if(!p.match(/^\S/)){let C=p.match(/^(\s+)/);if(C){let w=C[1];p.substring(C[0].length).length===0&&(m+=C[0].length)}}}else if(m>0){let p=d.substring(m).match(/^\s+/);p&&(m+=p[0].length)}c={line:h,ch:g+m};break}}else if(this.isHtmlHighlight(t)){let g=this.getHtmlHighlightPatterns(t),d=!1;for(let{pattern:u}of g){let p=new RegExp(u,"gi").exec(a);if(p){l=h;let C=p.index+p[0].length,w=a.substring(C),S=w.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),f=S?S[0].length:0;if(f>0&&w.length>f){let D=w.substring(f);if(!D.match(/^\S/)){let H=D.match(/^(\s+)/);if(H){let I=H[1];D.substring(H[0].length).length===0&&(f+=H[0].length)}}}else if(f>0){let D=w.substring(f).match(/^\s+/);D&&(f+=D[0].length)}c={line:h,ch:C+f},d=!0;break}}if(d)break}else if(a.includes(`==${t.text}==`)){l=h;let g=a.indexOf(`==${t.text}==`)+`==${t.text}==`.length,d=a.substring(g),u=d.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),m=u?u[0].length:0;if(m>0&&d.length>m){let p=d.substring(m);if(!p.match(/^\S/)){let C=p.match(/^(\s+)/);if(C){let w=C[1];p.substring(C[0].length).length===0&&(m+=C[0].length)}}}else if(m>0){let p=d.substring(m).match(/^\s+/);p&&(m+=p[0].length)}c={line:h,ch:g+m};break}}if(!c){console.warn("[Sidebar Highlights] could not find html highlight",{id:t.id,text:t.text,type:t.type}),new x.Notice("Could not find the highlight in the editor. It might have been modified.");return}i.setCursor(c),i.focus(),this.plugin.settings.useInlineFootnotes?this.plugin.inlineFootnoteManager.insertInlineFootnote(i,t,"")?setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,s)},50):new x.Notice("Could not insert inline footnote."):(this.plugin.app.commands.executeCommandById("editor:insert-footnote"),setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,s)},100))}async addMarkAnchorToHighlightWithTargetedUpdate(t){var M;let e=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);if(!e)return;let i=e.editor,s=e.file;if(!s)return;let n=i.getValue(),o=(M=t.endOffset)!=null?M:0,l=n.slice(o),c=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))+/,h=l.match(c);if(h){o+=h[0].length;let N=l.slice(h[0].length).match(/^\s+/);N&&(o+=N[0].length)}{let N=n.slice(o),F=new RegExp(String.raw`^\s*<span\s+class=['"]comment-anchor['"][^>]*>\s*<span\s+class=['"]comment-text['"][^>]*>[\s\S]*?<\/span>\s*<\/span>`,"i"),$;for(;$=N.match(F);)o+=$[0].length,N=n.slice(o)}{let N=n.slice(o),F=/^\s*<span\s+class=["']comment-anchor["'][^>]*>\s*<span\s+class=["']comment-text["'][^>]*>[\s\S]*?<\/span>\s*<\/span>/i,$;for(;$=N.match(F);)o+=$[0].length,N=n.slice(o)}let a=i.offsetToPos(o),g=o>0&&n.charAt(o-1)!==" "?" ":"",d=new Date,u=`${d.getFullYear()}${("0"+(d.getMonth()+1)).slice(-2)}${("0"+d.getDate()).slice(-2)}-${("0"+d.getHours()).slice(-2)}${("0"+d.getMinutes()).slice(-2)}${("0"+d.getSeconds()).slice(-2)}`,m=`${g}<span class="comment-anchor"><span class="comment-text" date-comment="${u}">Comment</span></span>`,p=i.getValue(),C=i.posToOffset(a),w=p.slice(C,C+200);if(/^\s*<span\s+class=['"]comment-anchor['"]/i.test(w))return;i.replaceRange(m,a);let f=n.slice(0,o)+g,D=m.indexOf('<span class="comment-text"'),H=m.indexOf(">",D),I=f.length+H+1,b=I+7;i.setSelection(i.offsetToPos(I),i.offsetToPos(b)),i.focus(),setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,s)},60)}async updateSingleHighlightFromEditor(t,e){let i=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);if(!i)return;let s=i.editor.getValue(),n=this.plugin.extractFootnotes(s),o=this.findAndParseHighlight(s,t,n);if(o){let l=this.plugin.highlights.get(e.path)||[],c=l.findIndex(h=>h.id===t.id);c!==-1&&(l[c]=o,this.plugin.highlights.set(e.path,l),await this.plugin.saveSettings(),this.updateItem(t.id))}}findAndParseHighlight(t,e,i){var l,c,h,a,g;console.log("=== findAndParseHighlight CALLED ==="),console.log("Looking for highlight:",e.text.substring(0,50));let s=!!e.color&&!e.isNativeComment||e.type==="html",n=e.isNativeComment?new RegExp(`%%${this.escapeRegex(e.text)}%%`,"gi"):s?new RegExp(`<(?:mark|span|font)[^>]*>${this.escapeRegex(e.text)}</(?:mark|span|font)>`,"gi"):new RegExp(`==${this.escapeRegex(e.text)}==`,"gi"),o;for(;(o=n.exec(t))!==null;)if(Math.abs(o.index-((l=e.startOffset)!=null?l:0))<100){let d=t.slice(o.index+o[0].length),u=[],m=0,p=/^\^\[([^\]]+)\]/,C=/^\[\^([a-zA-Z0-9_-]+)\](?!:)/,w=new RegExp(String.raw`^\s*<span\s+class=['"]comment-anchor['"][^>]*>\s*<span\s+class=['"]comment-text['"][^>]*>([\s\S]*?)<\/span>\s*<\/span>`,"i");for(;m<d.length;){let T=d.slice(m),P=T.match(/^\s+/);if(P){m+=P[0].length;continue}console.log("=== PARSING AT POS",m,"==="),console.log("Slice start (200 chars):",T.substring(0,200));let U=T.match(w);if(console.log("Anchor match result:",U?"MATCHED":"NO MATCH"),U){console.log("Matched anchor HTML:",U[0].substring(0,150));let Y=document.createElement("template");Y.innerHTML=U[0]||"";let z=Y.content.querySelector(".comment-text");console.log("Element found:",!!z),console.log("Element outerHTML:",(c=z==null?void 0:z.outerHTML)==null?void 0:c.substring(0,150));let R=((z==null?void 0:z.textContent)||Y.content.textContent||"").replace(/\s+/g," ").trim(),V,O=(z==null?void 0:z.getAttribute("date-comment"))||"";if(console.log("date-comment attribute value:",O),O&&/^\d{8}-\d{6}$/.test(O)){let G=Number(O.slice(0,4)),K=Number(O.slice(4,6))-1,j=Number(O.slice(6,8)),Z=Number(O.slice(9,11)),J=Number(O.slice(11,13)),X=Number(O.slice(13,15));V=new Date(G,K,j,Z,J,X).getTime()}else{let G=z==null?void 0:z.getAttribute("data-comment-ts");if(G){let K=Number(G);Number.isNaN(K)||(V=K)}}console.log("Pushing anchor token with content:",R.substring(0,50)),R&&u.push({type:"anchor",index:o.index+o[0].length+m,content:R,ts:V}),m+=U[0].length;continue}let B=T.match(p);if(B){console.log("Matched inline:",B[0]);let Y=(B[1]||"").trim();Y&&u.push({type:"inline",index:o.index+o[0].length+m,content:Y}),m+=B[0].length;continue}let q=T.match(C);if(q){console.log("Matched standard footnote:",q[0],"key:",q[1]);let Y=q[1],z=(i.get(Y)||"").trim();console.log("Standard footnote body:",z.substring(0,100)),z&&u.push({type:"standard",index:o.index+o[0].length+m,content:z}),m+=q[0].length;continue}break}u.sort((T,P)=>T.index-P.index);let S=[],f=new Set;for(let T of u)f.has(T.index)||(f.add(T.index),S.push(T));let D=new Set,H=T=>(T||"").replace(/\s+/g," ").trim().toLowerCase(),I=S.filter(T=>{let P=H(T.content);return D.has(P)?!1:(D.add(P),!0)});console.log("Tokens after dedup:",I.map(T=>({content:T.content.substring(0,30),type:T.type,ts:T.ts})));let b=I.map(T=>T.content),M=I.map(T=>T.ts),N=I.map(T=>T.type);console.log("Comment types array:",N);let F=b.length,$=((h=o[0].match(/<mark\b[^>]*>/i))==null?void 0:h[0])||"",A=(a=$.match(/date-highlight\s*=\s*["'](\d{8}-\d{6})["']/i))==null?void 0:a[1],v=(g=$.match(/data-highlight-ts\s*=\s*["'](\d+)["']/i))==null?void 0:g[1],y;if(A&&/^\d{8}-\d{6}$/.test(A)){let T=Number(A.slice(0,4)),P=Number(A.slice(4,6))-1,U=Number(A.slice(6,8)),B=Number(A.slice(9,11)),q=Number(A.slice(11,13)),Y=Number(A.slice(13,15));y=new Date(T,P,U,B,q,Y).getTime()}else if(v){let T=Number(v);Number.isNaN(T)||(y=T)}let L=e.createdAt,k=typeof y=="number"&&!Number.isNaN(y)?y:L;return console.log("=== RETURNING PARSED HIGHLIGHT ==="),console.log("Comment types:",N),console.log("Comment timestamps:",M),console.log("Footnote contents:",b),{...e,createdAt:k,footnoteContents:b,commentTimestamps:M,commentTypes:N,footnoteCount:F,startOffset:o.index,endOffset:o.index+o[0].length}}return null}async focusHighlightInEditor(t,e){var c;this.isPreservingPagination=!0,this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(h=>{h.classList.remove("selected","highlight-selected"),h.style.removeProperty("border-left-color"),h.style.removeProperty("box-shadow")});let s=this.plugin.selectedHighlightId;this.plugin.selectedHighlightId=t.id;let n=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(n){n.classList.add("selected");let h=this.plugin.highlights.get(t.filePath),a=h==null?void 0:h.find(g=>g.id===t.id);if(a){n.classList.add("highlight-selected");let g=a.color||this.plugin.settings.highlightColor,d=this.getUiColorFromDoc(g);n.style.borderLeftColor=d,n.style.boxShadow=`0 0 0 1.5px ${d}, var(--shadow-s)`}}if(this.isHighlightFocusing)return;this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isHighlightFocusing=!0,window.setTimeout(()=>{this.isHighlightFocusing=!1},2e3);let o=null,l=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);if(l&&l.file&&l.file.path===t.filePath)o=l;else{let h=this.plugin.app.workspace.getLeavesOfType("markdown");for(let a of h)if(a.view instanceof x.MarkdownView&&((c=a.view.file)==null?void 0:c.path)===t.filePath){o=a.view,this.plugin.app.workspace.setActiveLeaf(a,{focus:!0});break}}if(!o&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof x.TFile){let a=await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,e?x.Keymap.isModEvent(e):!1);return new Promise(g=>{let d=()=>{var m;let u=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);u&&((m=u.file)==null?void 0:m.path)===t.filePath?((async()=>{var p,C,w,S,f,D,H,I,b,M,N,F,$,A;try{let v=((H=(D=(w=(p=u.getMode)==null?void 0:p.call(u))!=null?w:(C=u.currentMode)==null?void 0:C.type)!=null?D:(f=(S=u.getState)==null?void 0:S.call(u))==null?void 0:f.mode)!=null?H:"").toString().toLowerCase(),y=((b=(I=u==null?void 0:u.contentEl)==null?void 0:I.querySelector)==null?void 0:b.call(I,".markdown-reading-view"))||(u==null?void 0:u.contentEl)||(u==null?void 0:u.containerEl)||null,L=(M=y==null?void 0:y.scrollTop)!=null?M:0;if(v!=="source"){let k=u.leaf||this.plugin.app.workspace.activeLeaf,T=(N=u.file)==null?void 0:N.path;k&&T&&(await k.setViewState({type:"markdown",state:{file:T,mode:"source"}},{focus:!0}),await new Promise(P=>requestAnimationFrame(P)))}if(await this.performHighlightFocus(u,t),v!=="source"){let k=u.leaf||this.plugin.app.workspace.activeLeaf,T=(F=u.file)==null?void 0:F.path;if(k&&T){await new Promise(P=>setTimeout(P,30)),await k.setViewState({type:"markdown",state:{file:T,mode:"preview"}},{focus:!0}),await new Promise(P=>setTimeout(P,30));try{let P=k==null?void 0:k.view,U=((A=($=P==null?void 0:P.contentEl)==null?void 0:$.querySelector)==null?void 0:A.call($,".markdown-reading-view"))||(P==null?void 0:P.contentEl)||(P==null?void 0:P.containerEl)||null;U&&typeof L=="number"&&(U.scrollTop=L)}catch(P){}}}}catch(v){console.warn("[Sidebar Highlights] ensure-source/restore-preview (newActiveView) failed",v),this.performHighlightFocus(u,t)}})(),g()):window.setTimeout(d,50)};window.setTimeout(d,100)})}o&&(async()=>{var h,a,g,d,u,m,p,C,w,S,f,D,H,I;try{let b=((p=(m=(g=(h=o.getMode)==null?void 0:h.call(o))!=null?g:(a=o.currentMode)==null?void 0:a.type)!=null?m:(u=(d=o.getState)==null?void 0:d.call(o))==null?void 0:u.mode)!=null?p:"").toString().toLowerCase(),M=((w=(C=o==null?void 0:o.contentEl)==null?void 0:C.querySelector)==null?void 0:w.call(C,".markdown-reading-view"))||(o==null?void 0:o.contentEl)||(o==null?void 0:o.containerEl)||null,N=(S=M==null?void 0:M.scrollTop)!=null?S:0;if(b!=="source"){let F=o.leaf||this.plugin.app.workspace.activeLeaf,$=(f=o.file)==null?void 0:f.path;F&&$&&(await F.setViewState({type:"markdown",state:{file:$,mode:"source"}},{focus:!0}),await new Promise(A=>requestAnimationFrame(A)))}if(await new Promise(F=>{requestAnimationFrame(async()=>{try{await this.performHighlightFocus(o,t)}finally{F()}})}),b!=="source"){let F=o.leaf||this.plugin.app.workspace.activeLeaf,$=(D=o.file)==null?void 0:D.path;if(F&&$){await new Promise(A=>setTimeout(A,30)),await F.setViewState({type:"markdown",state:{file:$,mode:"preview"}},{focus:!0}),await new Promise(A=>setTimeout(A,30));try{let A=F==null?void 0:F.view,v=((I=(H=A==null?void 0:A.contentEl)==null?void 0:H.querySelector)==null?void 0:I.call(H,".markdown-reading-view"))||(A==null?void 0:A.contentEl)||(A==null?void 0:A.containerEl)||null;v&&typeof N=="number"&&(v.scrollTop=N)}catch(A){}}}}catch(b){console.warn("[Sidebar Highlights] ensure-source/restore-preview (targetView) failed",b),requestAnimationFrame(()=>{this.performHighlightFocus(o,t)})}})()}isHtmlHighlight(t){return t.type==="html"}getHtmlHighlightPatterns(t){let e=this.escapeRegex(t.text),i=[],s=e.replace(/\s+/g,"(?:\\s|<[^>]+>)+");return i.push({pattern:`<mark[^>]*>${s}<\\/mark>`,tagLength:0}),i.push({pattern:`<span\\s+style=["'][^"']*background:\\s*[^;"']+[^"']*["'][^>]*>${e}<\\/span>`,tagLength:0}),i.push({pattern:`<font\\s+color=["'][^"']+["'][^>]*>${e}<\\/font>`,tagLength:0}),i.push({pattern:`<mark[^>]*>${e}<\\/mark>`,tagLength:0}),i.push({pattern:`<span\\s+class=["'][^"']*["'][^>]*>${e}<\\/span>`,tagLength:0}),i}performHighlightFocus(t,e){if(!t||!t.editor)return;this.contentAreaEl.scrollTop!==this.preservedScrollTop?requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isHighlightFocusing=!1}):this.isHighlightFocusing=!1;let s=t.editor.getValue(),n=[];if(e.isNativeComment){let g=`%%${this.escapeRegex(e.text)}%%`,d=new RegExp(g,"g"),u;for(;(u=d.exec(s))!==null;)n.push({index:u.index,length:u[0].length,tagStartLength:2,tagEndLength:2})}else if(this.isHtmlHighlight(e)){let g=this.getHtmlHighlightPatterns(e);for(let{pattern:d}of g){let u=new RegExp(d,"gi"),m;for(;(m=u.exec(s))!==null;){let p=m[0],C=p.lastIndexOf(e.text),w=C,S=p.length-C-e.text.length;n.push({index:m.index,length:m[0].length,tagStartLength:w,tagEndLength:S})}}}else{let g=`==${this.escapeRegex(e.text)}==`,d=new RegExp(g,"g"),u;for(;(u=d.exec(s))!==null;)n.push({index:u.index,length:u[0].length,tagStartLength:2,tagEndLength:2})}if(n.length===0)return;let o=n[0],l=1/0,c=!1;for(let g of n){let d=Math.abs(g.index-e.startOffset);d<l&&(l=d,o=g,c=!0)}!c||l>50;let h=t.editor.offsetToPos(o.index+o.tagStartLength),a=t.editor.offsetToPos(o.index+o.length-o.tagEndLength);if(t.editor.setSelection(h,a),this.plugin.settings.autoToggleFold)try{this.plugin.app.commands.executeCommandById("editor:toggle-fold")}catch(g){console.warn("Failed to execute toggle fold command:",g)}t.editor.scrollIntoView({from:h,to:a},!0),t.editor.focus()}focusHighlight(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async focusFootnoteInEditor(t,e,i){var o;let s=null,n=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);if(n&&n.file&&n.file.path===t.filePath)s=n;else{let l=this.plugin.app.workspace.getLeavesOfType("markdown");for(let c of l)if(c.view instanceof x.MarkdownView&&((o=c.view.file)==null?void 0:o.path)===t.filePath){s=c.view,this.plugin.app.workspace.setActiveLeaf(c,{focus:!0});break}}if(!s&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof x.TFile){await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,i?x.Keymap.isModEvent(i):!1),window.setTimeout(()=>this.focusFootnoteInEditor(t,e,i),200);return}window.setTimeout(()=>{let l=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);if(!l||!l.editor){new x.Notice("Could not access the editor.");return}let c=l.editor,h=c.getValue(),a=this.escapeRegex(t.text),g=null,d=1/0;if(t.isNativeComment){let H=`%%${a}%%`,I=new RegExp(H,"g"),b;for(;(b=I.exec(h))!==null;){let M=Math.abs(b.index-t.startOffset);M<d&&(d=M,g={index:b.index,length:b[0].length})}}else if(this.isHtmlHighlight(t)){let H=this.getHtmlHighlightPatterns(t);for(let{pattern:I}of H){let b=new RegExp(I,"gi"),M;for(;(M=b.exec(h))!==null;){let N=Math.abs(M.index-t.startOffset);N<d&&(d=N,g={index:M.index,length:M[0].length})}}}else{let H=`==${a}==`,I=new RegExp(H,"g"),b;for(;(b=I.exec(h))!==null;){let M=Math.abs(b.index-t.startOffset);M<d&&(d=M,g={index:b.index,length:b[0].length})}}if(!g){new x.Notice("Could not find the highlight in the editor.");return}let u=new ht,m=h.substring(g.index+g.length),p=[];u.extractInlineFootnotes(h,g.index+g.length).forEach(H=>{p.push({type:"inline",content:H.content,startIndex:H.startIndex,endIndex:H.endIndex})});let w=/(\s*\[\^(\w+)\])/g,S,f=0;for(;(S=w.exec(m))!==null;){let H=m.substring(f,S.index),I=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(H);if(S.index===f||I)p.push({type:"standard",content:S[2],startIndex:g.index+g.length+S.index,endIndex:g.index+g.length+S.index+S[0].length}),f=S.index+S[0].length;else break}if(p.sort((H,I)=>H.startIndex-I.startIndex),p.length===0){new x.Notice("No footnotes found for this highlight.");return}if(e>=p.length){new x.Notice("Footnote index out of range.");return}let D=p[e];if(D.type==="inline"){let H=h.substring(D.startIndex,D.endIndex),I=H.indexOf("^"),b=D.startIndex+I,M=c.offsetToPos(b);if(this.plugin.settings.selectTextOnCommentClick){let N=D.startIndex+H.indexOf("[")+1,F=D.startIndex+H.lastIndexOf("]"),$=c.offsetToPos(N),A=c.offsetToPos(F);c.scrollIntoView({from:$,to:A},!0),c.setSelection($,A),c.focus()}else c.scrollIntoView({from:M,to:M},!0),c.setCursor(M),c.focus()}else{let H=D.content,I=new RegExp(`^\\[\\^${this.escapeRegex(H)}\\]:\\s*(.+)$`,"m"),b=h.match(I);if(!b){new x.Notice("Could not find footnote definition.");return}let M=h.indexOf(b[0]),N=c.offsetToPos(M);if(this.plugin.settings.selectTextOnCommentClick){let F=b[1],$=M+b[0].indexOf(F),A=$+F.length,v=c.offsetToPos($),y=c.offsetToPos(A);c.scrollIntoView({from:v,to:y},!0),c.setSelection(v,y),c.focus()}else c.scrollIntoView({from:N,to:N},!0),c.setCursor(N),c.focus()}},150)}changeHighlightColor(t,e){this.plugin.updateHighlight(t.id,{color:e},t.filePath)}getColorName(t){let e=this.plugin.settings.customColorNames,i=this.plugin.settings.customColors;if(t===i.yellow&&e.yellow.trim())return e.yellow.trim();if(t===i.red&&e.red.trim())return e.red.trim();if(t===i.teal&&e.teal.trim())return e.teal.trim();if(t===i.blue&&e.blue.trim())return e.blue.trim();if(t===i.green&&e.green.trim())return e.green.trim();let s=this.plugin.settings.extraColors||[],n=s.find(l=>(l.ui||"").toLowerCase()===(t||"").toLowerCase());if(n&&n.name&&n.name.trim())return n.name.trim();let o=s.find(l=>(l.doc||"").toLowerCase()===(t||"").toLowerCase());return o&&o.name&&o.name.trim()?o.name.trim():t}normalizeColor6(t){if(!t)return"";let e=t.trim().toLowerCase();if(e.startsWith("rgba")||e.startsWith("rgb")){let i=e.replace(/rgba?\(|\)/g,"").split(",").map(c=>parseFloat(c.trim())),s=Math.max(0,Math.min(255,Math.round(i[0]||0))),n=Math.max(0,Math.min(255,Math.round(i[1]||0))),o=Math.max(0,Math.min(255,Math.round(i[2]||0))),l=c=>("0"+c.toString(16)).slice(-2);return"#"+l(s)+l(n)+l(o)}return e.startsWith("#")&&(e=e.slice(1)),e.length===8&&(e=e.slice(0,6)),e.length===3&&(e=e.split("").map(i=>i+i).join("")),e.length<6&&(e=(e+"000000").slice(0,6)),"#"+e}toRgbTupleString(t){if(!t)return"255, 215, 0";let e=this.normalizeColor6(t);if(e.startsWith("#")){let s=e.slice(1),n=parseInt(s.slice(0,2),16),o=parseInt(s.slice(2,4),16),l=parseInt(s.slice(4,6),16);return`${n}, ${o}, ${l}`}let i=t.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return i?`${i[1]}, ${i[2]}, ${i[3]}`:"255, 215, 0"}getUiColorFromDoc(t){var h;let e=this.plugin.settings,i=e.customColors,s=(h=e.customColorsDoc)!=null?h:i,n=this.normalizeColor6(t);if(this.normalizeColor6(s.yellow)===n)return this.normalizeColor6(i.yellow);if(this.normalizeColor6(s.red)===n)return this.normalizeColor6(i.red);if(this.normalizeColor6(s.teal)===n)return this.normalizeColor6(i.teal);if(this.normalizeColor6(s.blue)===n)return this.normalizeColor6(i.blue);if(this.normalizeColor6(s.green)===n)return this.normalizeColor6(i.green);let o=e.extraColors||[],l=o.find(a=>this.normalizeColor6(a==null?void 0:a.doc)===n);if(l)return this.normalizeColor6(l.ui||t);let c=o.find(a=>this.normalizeColor6(a==null?void 0:a.ui)===n);return c?this.normalizeColor6(c.ui||t):this.normalizeColor6(t)}applyUiColorToElement(t,e){if(t)try{let i=t.getAttribute("data-highlight-id"),s=e||(i?this.getHighlightById(i):null);if(!s)return;let n=s.color||this.plugin.settings.highlightColor,o=this.getUiColorFromDoc(n),l=this.toRgbTupleString(o);this.applyUiColorToElement(t)}catch(i){}}applyUiColorToAllCards(){if(!this.containerEl)return;let t=Array.from(this.containerEl.querySelectorAll("[data-highlight-id]"));for(let e of t){let i=e.getAttribute("data-highlight-id");if(!i)continue;let s=this.getHighlightById(i);if(!s)continue;let n=s.color||this.plugin.settings.highlightColor,o=this.getUiColorFromDoc(n),l=this.toRgbTupleString(o);e.style.setProperty("--hl-ui-rgb",l),e.style.setProperty("--text-highlight-bg-rgb",l)}}renderGroupedHighlights(t,e,i=!1){let s=new Map,n=new Map;t.forEach(l=>{var h;let c;if(this.groupingMode==="color"){let a=l.color||this.plugin.settings.highlightColor;c=a,n.set(c,a)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let a=l.isNativeComment?0:((h=l.footnoteContents)==null?void 0:h.filter(g=>g.trim()!=="").length)||0;c=a===0?"No Comments":a===1?"1 Comment":`${a} Comments`}else if(this.groupingMode==="parent"){let a=l.filePath.split("/");a.length>1?c=a[a.length-2]:c="Root"}else if(this.groupingMode==="collection"){let a=this.plugin.collectionsManager.getAllCollections().filter(g=>g.highlightIds.includes(l.id));a.length===0?c="No Collections":a.length===1?c=a[0].name:c=a.map(g=>g.name).sort().join(", ")}else if(this.groupingMode==="filename")c=(l.filePath.split("/").pop()||l.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(l.createdAt){let a=new Date(l.createdAt),g=a.getFullYear(),d=String(a.getMonth()+1).padStart(2,"0"),u=String(a.getDate()).padStart(2,"0");c=`${g}-${d}-${u}`}else c="No Date";else c="Default";s.has(c)||s.set(c,[]),s.get(c).push(l)}),Array.from(s.entries()).sort(([l],[c])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(l==="No Comments"&&c==="No Comments")return 0;if(l==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(c==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let h=parseInt(l.split(" ")[0])||0,a=parseInt(c.split(" ")[0])||0;return this.groupingMode==="comments-asc"?h-a:a-h}else{if(this.groupingMode==="tag")return l==="No Tags"&&c==="No Tags"?0:l==="No Tags"?1:c==="No Tags"?-1:l.localeCompare(c);if(this.groupingMode==="parent")return l==="Root"&&c==="Root"?0:l==="Root"?-1:c==="Root"?1:l.localeCompare(c);if(this.groupingMode==="collection")return l==="No Collections"&&c==="No Collections"?0:l==="No Collections"?1:c==="No Collections"?-1:l.localeCompare(c);if(this.groupingMode==="filename")return l.localeCompare(c);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(l==="No Date"&&c==="No Date")return 0;if(l==="No Date")return 1;if(c==="No Date")return-1;let h=new Date(l),a=new Date(c);return this.groupingMode==="date-created-asc"?h.getTime()-a.getTime():a.getTime()-h.getTime()}}return l.localeCompare(c)}).forEach(([l,c])=>{let h=this.listContainerEl.createDiv({cls:"highlight-group-header"}),a=h.createSpan();if(this.groupingMode==="color"&&n.has(l)){let b=n.get(l),M=a.createDiv({cls:"group-color-square",attr:{"data-color":b}});M.style.backgroundColor=b}if(this.groupingMode==="tag"){let b=a.createDiv({cls:"group-tag-icon"});(0,x.setIcon)(b,"tag")}let g=a.createSpan();g.textContent=this.groupingMode==="color"?this.getColorName(l):l;let u=h.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),p=new Set(c.map(b=>b.filePath)).size,C=c.filter(b=>b.isNativeComment).length,w=c.filter(b=>!b.isNativeComment).length,S=u.createDiv({cls:"highlight-line-info"}),f=S.createDiv({cls:"line-icon"});if((0,x.setIcon)(f,"highlighter"),S.createSpan({text:`${w}`}),this.showNativeComments){let b=u.createDiv({cls:"highlight-line-info"}),M=b.createDiv({cls:"line-icon"});(0,x.setIcon)(M,"captions"),b.createSpan({text:`${C}`})}let D=u.createDiv({cls:"highlight-line-info"}),H=D.createDiv({cls:"line-icon"});(0,x.setIcon)(H,"file-text"),D.createSpan({text:`${p}`});let I;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?I=c.sort((b,M)=>{let N=b.createdAt||0,F=M.createdAt||0;return this.groupingMode==="date-created-asc"?N-F:F-N}):I=c.sort((b,M)=>b.startOffset-M.startOffset),I.forEach(b=>{this.createHighlightItem(this.listContainerEl,b,e,i)})}),this.applyUiColorToAllCards()}updateCommentsToggleIcon(t){t.empty();let i=this.areCommentsGloballyExpanded()?"chevrons-down-up":"chevrons-up-down";(0,x.setIcon)(t,i)}toggleAllComments(){let t=[];for(let[,s]of this.plugin.highlights)t.push(...s);let i=!this.areCommentsGloballyExpanded();t.forEach(s=>{var o;if(s.isNativeComment)return;(((o=s.footnoteContents)==null?void 0:o.filter(l=>l.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.set(s.id,i)})}areCommentsGloballyExpanded(){let t=[];for(let[,e]of this.plugin.highlights)t.push(...e);return t.some(e=>{var s;return e.isNativeComment?!1:(((s=e.footnoteContents)==null?void 0:s.filter(n=>n.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.get(e.id)})}getHighlightCommentsVisibility(t){var i;let e=this.highlightCommentsVisible.get(t.id);if(e!==void 0)return e;if(!t.isNativeComment&&(((i=t.footnoteContents)==null?void 0:i.filter(n=>n.trim()!=="").length)||0)>0){let n=this.areCommentsGloballyExpanded();return this.highlightCommentsVisible.set(t.id,n),n}return!1}resetAllColors(){let t;if(this.viewMode==="current")t=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all"){t=[];for(let[,i]of this.plugin.highlights)t.push(...i)}else this.viewMode==="collections"&&this.currentCollectionId?t=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId):t=[];let e=!1;t.forEach(i=>{if(i.color){let s=this.plugin.highlights.get(i.filePath);if(s){let n=s.find(o=>o.id===i.id);if(n&&n.color){let o={...n,color:void 0},l=s.indexOf(n);s[l]=o,this.plugin.highlights.set(i.filePath,[...s]),e=!0}}}}),e&&(this.plugin.saveSettings(),this.renderContent())}extractTagsFromHighlight(t){let e=[];if(t.footnoteContents){for(let i of t.footnoteContents)if(i.trim()!==""){let s=i.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);s&&s.forEach(n=>{let o=n.substring(1);e.includes(o)||e.push(o)})}}return e}getAllTagsInFile(){let t=new Set;if(this.viewMode==="current")this.plugin.getCurrentFileHighlights().forEach(i=>{this.extractTagsFromHighlight(i).forEach(n=>t.add(n))});else if(this.viewMode==="all")for(let[e,i]of this.plugin.highlights)i.forEach(s=>{this.extractTagsFromHighlight(s).forEach(o=>t.add(o))});else this.viewMode==="collections"&&this.currentCollectionId&&this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId).forEach(i=>{this.extractTagsFromHighlight(i).forEach(n=>t.add(n))});return Array.from(t).sort((e,i)=>e.localeCompare(i,void 0,{numeric:!0,sensitivity:"base"}))}getAllCollectionsInCurrentScope(){let t=new Set,e=[];if(this.viewMode==="current")e=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all")for(let[s,n]of this.plugin.highlights)e.push(...n);else this.viewMode==="collections"&&this.currentCollectionId&&(e=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId));return e.forEach(s=>{this.plugin.collectionsManager.getCollectionsForHighlight(s.id).forEach(o=>{t.add(o.id)})}),this.plugin.collectionsManager.getAllCollections().filter(s=>t.has(s.id))}showTagFilterMenu(t){let e=this.getAllTagsInFile(),i=this.getAllCollectionsInCurrentScope();if(e.length===0&&i.length===0){new x.Notice("No tags or collections found");return}let s=i.sort((o,l)=>o.name.localeCompare(l.name,void 0,{numeric:!0,sensitivity:"base"})),n=[{text:"Clear",icon:"x",className:"highlights-dropdown-clear",onClick:()=>{this.selectedTags.clear(),this.selectedCollections.clear(),this.renderContent(),this.showTagActive();let o={};e.forEach(l=>{o[`tag-${l}`]=!1}),s.forEach(l=>{o[`collection-${l.id}`]=!1}),this.dropdownManager.updateAllCheckboxStates(o)}}];e.length>0&&n.push(...e.map(o=>({id:`tag-${o}`,text:`#${o}`,uncheckedIcon:"tag",checked:this.selectedTags.has(o),onClick:()=>{this.selectedTags.has(o)?this.selectedTags.delete(o):this.selectedTags.add(o),this.renderContent(),this.showTagActive()}}))),e.length>0&&s.length>0&&n.push({text:"",separator:!0}),s.length>0&&n.push(...s.map(o=>({id:`collection-${o.id}`,text:o.name,uncheckedIcon:"folder-open",checked:this.selectedCollections.has(o.name),onClick:()=>{this.selectedCollections.has(o.name)?this.selectedCollections.delete(o.name):this.selectedCollections.add(o.name),this.renderContent(),this.showTagActive()}}))),this.dropdownManager.showDropdown(t.currentTarget,n)}showCollectionsMenu(t,e){let i=this.plugin.collectionsManager.getAllCollections(),s=[{text:"Clear",icon:"x",className:"highlights-dropdown-clear",onClick:()=>{i.forEach(o=>{this.plugin.collectionsManager.removeHighlightFromCollection(o.id,e.id)}),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent();let n={};i.forEach(o=>{n[`collection-${o.id}`]=!1}),this.dropdownManager.updateAllCheckboxStates(n)}},{text:"New collection",icon:"plus",className:"highlights-dropdown-clear",onClick:()=>{this.showNewCollectionDialog(e.id)}}];i.length>0?s.push(...i.map(n=>({id:`collection-${n.id}`,text:n.name,uncheckedIcon:"folder-open",checked:n.highlightIds.includes(e.id),onClick:()=>{n.highlightIds.includes(e.id)?(this.plugin.collectionsManager.removeHighlightFromCollection(n.id,e.id),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.currentCollectionId===n.id&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent()):(this.plugin.collectionsManager.addHighlightToCollection(n.id,e.id),this.updateHighlightCollectionCount(e),this.groupingMode==="collection"&&this.renderContent())}}))):s.push({text:"No collections available",className:"highlights-dropdown-empty",onClick:()=>{}}),this.dropdownManager.showDropdown(t.currentTarget,s)}updateCollectionNavButton(t){t.empty(),this.viewMode==="collections"&&this.currentCollectionId?((0,x.setIcon)(t,"arrow-left"),(0,x.setTooltip)(t,"Back to Collections"),t.classList.add("active","collection-nav-back")):((0,x.setIcon)(t,"folder-plus"),(0,x.setTooltip)(t,"New collection"),t.classList.remove("active","collection-nav-back"))}toggleSearch(){var e;if(!this.plugin.settings.showToolbar)return;this.searchExpanded=!this.searchExpanded;let t=this.contentEl.querySelector(".highlights-search-input-container");t&&(this.searchExpanded?(t.classList.remove("hidden"),this.searchButton.classList.add("active"),(0,x.setIcon)(this.searchButton,"x"),(0,x.setTooltip)(this.searchButton,"Close search"),window.setTimeout(()=>this.searchInputEl.focus(),100)):(t.classList.add("hidden"),this.searchButton.classList.remove("active"),(0,x.setIcon)(this.searchButton,"search"),(0,x.setTooltip)(this.searchButton,"Search highlights"),(e=this.simpleSearchManager)==null||e.clear(),this.currentSearchTokens=[],this.currentParsedSearch={ast:null},this.renderContent()))}enableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.remove("disabled"),this.searchInputEl&&this.searchInputEl.classList.remove("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((i,s)=>{let n=s===t.length-1,o=s===2;this.viewMode==="collections"&&!this.currentCollectionId&&!n&&!o?i.classList.add("disabled"):i.classList.remove("disabled")});let e=this.contentEl.querySelector(".highlights-search-container button:last-of-type");e&&this.updateCollectionNavButton(e)}disableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.add("disabled"),this.searchInputEl&&this.searchInputEl.classList.add("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((i,s)=>{s===t.length-1?i.classList.remove("disabled"):i.classList.add("disabled")});let e=this.contentEl.querySelector(".highlights-search-container button:last-of-type");e&&this.updateCollectionNavButton(e)}updateHighlightCollectionCount(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(!e)return;let i=e.querySelector(".highlight-line-info:last-child span");if(i){let s=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);i.textContent=`${s}`}}showTagActive(){if(!this.plugin.settings.showToolbar)return;let t=this.contentEl.querySelector(".highlights-tag-filter-button");t&&(this.selectedTags.size>0||this.selectedCollections.size>0?t.classList.add("active"):t.classList.remove("active"))}showNewCollectionDialog(t){new mt(this.plugin.app,(e,i)=>{let s=this.plugin.collectionsManager.createCollection(e,i);t&&this.plugin.collectionsManager.addHighlightToCollection(s.id,t),this.animateCollectionCreation(s.id)}).open()}showCollectionMenu(t,e){let i=new x.Menu;i.addItem(s=>{s.setTitle("Edit").setIcon("edit").onClick(()=>{this.showEditCollectionDialog(e)})}),i.addItem(s=>{s.setTitle("Delete").setIcon("trash").onClick(async()=>{await this.animateCollectionDeletion(e.id)})}),i.showAtMouseEvent(t)}showEditCollectionDialog(t){new pt(this.plugin.app,t,(e,i)=>{t.name=e,t.description=i,this.plugin.saveSettings(),this.plugin.refreshSidebar()}).open()}updateNativeCommentsToggleState(t){this.showNativeComments?((0,x.setIcon)(t,"captions"),t.classList.remove("active"),(0,x.setTooltip)(t,"Toggle native comments")):((0,x.setIcon)(t,"captions-off"),t.classList.add("active"),(0,x.setTooltip)(t,"Toggle native comments"))}animateCollectionCreation(t){this.plugin.refreshSidebar(),requestAnimationFrame(()=>{let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);e&&(e.classList.add("preparing-animation"),requestAnimationFrame(()=>{e.classList.remove("preparing-animation"),e.classList.add("animating-in"),window.setTimeout(()=>{e.classList.remove("animating-in")},400)}))})}async animateCollectionDeletion(t){let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);if(!e)return await this.plugin.collectionsManager.deleteCollectionWithConfirmation(t);let i=this.plugin.collectionsManager.getCollection(t);return!i||!confirm(`Are you sure you want to delete "${i.name}"?`)?!1:(e.classList.add("animating-out"),new Promise(n=>{window.setTimeout(()=>{this.plugin.collectionsManager.deleteCollection(t),this.plugin.refreshSidebar(),n(!0)},220)}))}toggleNativeCommentsVisibility(){this.showNativeComments=!this.showNativeComments,this.plugin.app.saveLocalStorage("sidebar-highlights-show-native-comments",this.showNativeComments.toString())}handleSearchInput(t,e){this.currentParsedSearch=e,this.currentSearchTokens=st.getTokensFromQuery(t),this.renderContent()}removeSearchToken(t){this.simpleSearchManager.updateSuggestions({tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}getHighlightById(t){for(let[e,i]of this.plugin.highlights){let s=i.find(n=>n.id===t);if(s)return s}return null}getAvailableTags(){let t=new Set;for(let e of this.plugin.highlights.values())for(let i of e)this.extractTagsFromHighlight(i).forEach(n=>t.add(n));return Array.from(t).sort()}getAvailableCollections(){return this.plugin.collectionsManager.getAllCollections().map(t=>t.name).sort()}applyAllFilters(t){return t.filter(e=>{if(!this.passesSmartSearchFilter(e))return!1;if(this.selectedTags.size>0){let n=this.extractTagsFromHighlight(e);if(!Array.from(this.selectedTags).some(l=>n.includes(l)))return!1}if(this.selectedCollections.size>0){let n=this.plugin.collectionsManager.getCollectionsForHighlight(e.id);if(!Array.from(this.selectedCollections).some(l=>n.some(c=>c.name===l)))return!1}if(!this.showNativeComments&&e.isNativeComment)return!1;let s=this.plugin.settings.minimumCharacterCount;return!(s>0&&(e.type==="highlight"||e.type==="html"||e.isNativeComment)&&e.text.length<s)})}passesSmartSearchFilter(t){return this.currentParsedSearch.ast?this.evaluateASTNode(this.currentParsedSearch.ast,t):!0}evaluateASTNode(t,e){if(t.type==="filter"){let i=t,s=this.highlightMatchesFilter(e,i);return i.exclude?!s:s}else if(t.type==="text"){let i=t;return e.text.toLowerCase().includes(i.value.toLowerCase())||e.filePath.toLowerCase().replace(/\.md$/,"").includes(i.value.toLowerCase())}else if(t.type==="operator"){let i=t,s=this.evaluateASTNode(i.left,e),n=this.evaluateASTNode(i.right,e);return i.operator==="AND"?s&&n:s||n}return!1}isConsecutiveTextNodes(t){return this.containsOnlyTextNodes(t.left)&&this.containsOnlyTextNodes(t.right)}containsOnlyTextNodes(t){if(t.type==="text")return!0;if(t.type==="operator"){let e=t;return e.operator==="AND"&&this.containsOnlyTextNodes(e.left)&&this.containsOnlyTextNodes(e.right)}return!1}extractConsecutiveText(t){if(t.type==="text")return t.value;if(t.type==="operator"){let e=t,i=this.extractConsecutiveText(e.left),s=this.extractConsecutiveText(e.right);return`${i} ${s}`}return""}highlightMatchesFilter(t,e){return e.filterType==="tag"?this.extractTagsFromHighlight(t).includes(e.value):e.filterType==="collection"?this.plugin.collectionsManager.getCollectionsForHighlight(t.id).map(n=>n.name).includes(e.value):!1}};function gt(_){let r=`/* src/styles.css */
.comment-anchor {
  position: relative;
  display: inline-block;
  margin-right: 0.15em;
}
.comment-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  vertical-align: -0.12em;
  cursor: pointer;
  color: var(--text-faint);
  transition:
    transform .12s,
    color .12s,
    opacity .12s;
  opacity: 0.7;
}
.comment-icon svg {
  width: 100%;
  height: 100%;
  stroke: currentColor;
}
.comment-icon:hover {
  transform: scale(1.35);
  color: var(--text-normal);
  opacity: 1;
}
.comment-anchor > .comment-text {
  opacity: 0;
}
.comment-anchor:hover > .comment-text {
  opacity: 1;
}
.comment-text {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translate(-50%, -0.45em);
  width: max-content;
  max-width: min(60ch, 90vw);
  background: var(--background-primary);
  color: var(--text-normal);
  border: 1px solid var(--background-modifier-border);
  border-radius: var(--radius-m);
  padding: 0.6em;
  box-shadow: var(--shadow-s);
  opacity: 0;
  pointer-events: none;
  transition: opacity .12s;
  z-index: 999;
}
.comment-anchor.open-left > .comment-text {
  right: 0;
  left: auto;
  transform: translateY(-0.45em);
}
.comment-anchor.open-right > .comment-text {
  left: 0;
  transform: translateY(-0.45em);
}
.callout,
.callout-content {
  overflow: visible;
}
`,t=document.createElement("style");t.setAttribute("data-plugin","hover-comment-tooltip-integrated"),t.textContent=r,document.head.appendChild(t),_.register(()=>t.remove());let e=s=>{if(s._hctBound)return;s._hctBound=!0,s.style.position||(s.style.position="relative");let n=s.querySelector(".comment-text");if(!n)return;if(!s.querySelector(".comment-icon")){let h=document.createElement("span");h.className="comment-icon",h.textContent="\u{1F4AC}",s.insertBefore(h,s.firstChild)}n.style.position=n.style.position||"absolute",n.style.pointerEvents="none";let o=()=>{let h=n.cloneNode(!0);h.style.visibility="hidden",document.body.appendChild(h);let a=h.getBoundingClientRect().width;document.body.removeChild(h);let g=s.getBoundingClientRect(),d=window.innerWidth||document.documentElement.clientWidth;s.classList.remove("open-left","open-right");let u=g.left+a+16>d,m=g.right-a-16<0;if(u&&!m)s.classList.add("open-left");else if(m&&!u)s.classList.add("open-right");else{let p=g.left+g.width/2,C=d/2;s.classList.add(p<C?"open-right":"open-left")}},l=()=>{},c=s.querySelector(".comment-icon")||s;c.addEventListener("mouseenter",o),c.addEventListener("mouseleave",l),_.register(()=>{c.removeEventListener("mouseenter",o),c.removeEventListener("mouseleave",l)})};_.registerMarkdownPostProcessor(s=>{s.querySelectorAll(".comment-anchor").forEach(e)});let i=new MutationObserver(s=>{for(let n of s)n.type==="childList"&&n.addedNodes.forEach(o=>{var l,c;o instanceof HTMLElement&&((l=o.matches)!=null&&l.call(o,".comment-anchor")&&e(o),(c=o.querySelectorAll)==null||c.call(o,".comment-anchor").forEach(h=>e(h)))})});i.observe(document.body,{childList:!0,subtree:!0}),_.register(()=>i.disconnect())}var Et=require("obsidian");var dt=require("obsidian"),xt=class extends dt.AbstractInputSuggest{constructor(t,e){super(t,e);this.inputEl=e,this.folders=this.app.vault.getAllFolders(!0).map(i=>(0,dt.normalizePath)(i.path)).filter(i=>i!==""),this.files=this.app.vault.getFiles().map(i=>(0,dt.normalizePath)(i.path))}getSuggestions(t){let e=t.toLowerCase().trim();if(!e)return this.folders.slice(0,10);let i=this.folders.filter(n=>n.toLowerCase().includes(e)),s=this.files.filter(n=>n.toLowerCase().includes(e));return[...i,...s].slice(0,20)}renderSuggestion(t,e){e.setText(t)}selectSuggestion(t){this.inputEl.value=t;let e=new Event("input");this.inputEl.dispatchEvent(e),this.close()}};var Tt=class extends Et.Modal{constructor(t,e,i){super(t);this.excludedFiles=[...e],this.onUpdate=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("div",{cls:"modal-title",text:"Excluded files"}),this.renderStatusMessage(t),this.renderExcludedFilesList(t);let e=t.createDiv({cls:"setting-item"});e.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:"Filter"});let n=e.createDiv({cls:"setting-item-control"}).createDiv({cls:"excluded-files-input-container"});n.style.display="flex",n.style.gap="8px",this.filterInput=n.createEl("input",{type:"text",placeholder:"Enter file or folder path..."}),this.filterInput.style.flex="1",this.fileFolderSuggest=new xt(this.app,this.filterInput),n.createEl("button",{text:"Add",cls:"mod-cta"}).addEventListener("click",()=>this.addFilter()),this.filterInput.addEventListener("keydown",l=>{l.key==="Enter"&&this.addFilter()}),this.renderModalButtons(t)}renderStatusMessage(t){let e=t.querySelector(".excluded-files-status");e&&e.remove();let i=t.createDiv({cls:"excluded-files-status"});i.style.marginTop="20px",this.excludedFiles.length===0?(i.setText("No excluded filter is applied right now. Add one below."),i.style.paddingBottom="20px"):(i.setText("Files matching the following filters are currently excluded:"),i.style.paddingBottom="10px")}renderExcludedFilesList(t){let e=t.querySelector(".excluded-files-list");if(e&&e.remove(),this.excludedFiles.length>0){let i=t.querySelector(".setting-item"),s=t.createDiv({cls:"excluded-files-list"});i&&t.insertBefore(s,i),this.excludedFiles.forEach(n=>{let o=s.createDiv({cls:"setting-item excluded-file-item"});o.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:n});let h=o.createDiv({cls:"setting-item-control"}).createEl("button",{cls:"clickable-icon"});(0,Et.setIcon)(h,"x"),h.addEventListener("click",()=>{this.removeFilter(n)})})}}renderModalButtons(t){let e=t.createDiv({cls:"modal-button-container"});e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="8px",e.style.marginTop="20px",e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>this.close())}addFilter(){let t=this.filterInput.value.trim();t&&!this.excludedFiles.includes(t)&&(this.excludedFiles.push(t),this.filterInput.value="",this.refreshContent(),this.onUpdate(this.excludedFiles))}removeFilter(t){this.excludedFiles=this.excludedFiles.filter(e=>e!==t),this.refreshContent(),this.onUpdate(this.excludedFiles)}refreshContent(){let t=this.contentEl.querySelector(".excluded-files-status");t&&(this.excludedFiles.length===0?(t.setText("No excluded filter is applied right now. Add one below."),t.style.paddingBottom="20px"):(t.setText("Files matching the following filters are currently excluded:"),t.style.paddingBottom="10px")),this.renderExcludedFilesList(this.contentEl)}onClose(){let{contentEl:t}=this;t.empty()}};var Ht=class extends E.SuggestModal{constructor(t){super(t.app);this.plugin=t,this.setPlaceholder("Choose a highlight type\u2026")}getSuggestions(t){let e=(this.plugin.settings.extraColors||[]).map((s,n)=>({name:s.name||`Highlight ${n+1}`,ui:s.ui||"#cccccc",doc:s.doc||s.ui||"#cccccc"})),i=(t||"").toLowerCase().trim();return e.filter(s=>s.name.toLowerCase().includes(i))}renderSuggestion(t,e){e.addClass("mod-search-suggestion");let i=e.createDiv({cls:"mark-palette-row"}),s=i.createSpan({cls:"swatch"});s.style.background=t.ui;let n=i.createSpan({cls:"swatch doc"});n.style.background=t.doc,i.createSpan({cls:"label",text:t.name})}onChooseSuggestion(t){var i;let e=(i=this.plugin.app.workspace.getActiveViewOfType(E.MarkdownView))==null?void 0:i.editor;e&&this.plugin._applyMarkToSelection(e,t)}},ot={settingsVersion:"1.14.0",highlightColor:"#ffd700",sidebarPosition:"right",highlights:{},collections:{},groupingMode:"none",showFilenames:!0,showTimestamps:!0,showHighlightActions:!0,showToolbar:!0,autoToggleFold:!1,useInlineFootnotes:!1,selectTextOnCommentClick:!1,excludeExcalidraw:!0,excludedFiles:[],dateFormat:"YYYY-MM-DD HH:mm:ss",minimumCharacterCount:0,highlightFontSize:11,detailsFontSize:11,commentFontSize:11,customColors:{yellow:"#ffd700",red:"#ff6b6b",teal:"#4ecdc4",blue:"#45b7d1",green:"#96ceb4"},customColorsDoc:{yellow:"#ffd700",red:"#ff6b6b",teal:"#4ecdc4",blue:"#45b7d1",green:"#96ceb4"},customColorNames:{yellow:"",red:"",teal:"",blue:"",green:""}},St="highlights-sidebar",Mt=class extends E.Plugin{constructor(){super(...arguments);this._registeredMarkCmdIds=new Set;this.highlights=new Map;this.collections=new Map;this.sidebarView=null;this.detectHighlightsTimeout=null;this.selectedHighlightId=null;this.collectionCommands=new Set}registerMarkCommands(){(this.settings.extraColors||[]).map((e,i)=>{let s=e.name||`Highlight ${i+1}`,n=(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return{name:s,slug:n,ui:e.ui||"#cccccc",doc:e.doc||e.ui||"#cccccc"}}).forEach(e=>{let i=`mark-with-${e.slug||"highlight"}`;this._registeredMarkCmdIds.has(i)||(this.addCommand({id:i,name:`Mark: ${e.name}`,editorCallback:s=>{this._applyMarkToSelection(s,{name:e.name,ui:e.ui,doc:e.doc})}}),this._registeredMarkCmdIds.add(i))})}_slugifyName(t){return(t||"highlight").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")}_stripAlphaHex(t){if(!t)return"#cccccc";let e=(t+"").replace("#","");return"#"+(e.length>=6?e.slice(0,6):e.padEnd(6,"0"))}_applyMarkToSelection(t,e){let i=this._stripAlphaHex((e==null?void 0:e.doc)||(e==null?void 0:e.ui)||this.settings.customColors.yellow),s=`sbh-${this._slugifyName((e==null?void 0:e.name)||"")}`,n=new Date,l=`<mark date-highlight="${`${n.getFullYear()}${("0"+(n.getMonth()+1)).slice(-2)}${("0"+n.getDate()).slice(-2)}-${("0"+n.getHours()).slice(-2)}${("0"+n.getMinutes()).slice(-2)}${("0"+n.getSeconds()).slice(-2)}`}" class="${s}" style="background: ${i};">`,c="</mark>",h=t.getSelection();if(h&&/^<mark[\s\S]*>[\s\S]*<\/mark>$/.test(h)){let a=h.replace(/^<mark[^>]*>/,"").replace(/<\/mark>$/,"");t.replaceSelection(a),new E.Notice("Removed mark");return}if(t.replaceSelection(l+h+c),!h||h.length===0){let a=t.getCursor(),g={line:a.line,ch:a.ch-c.length};t.setCursor(g)}new E.Notice(`Marked as ${(e==null?void 0:e.name)||"highlight"}`)}async onload(){await this.loadSettings(),this.addCommand({id:"insert-hover-comment-anchor",name:"Insert Span Comment",editorCallback:t=>{let e=new Date,s=`<span class="comment-anchor"><span class="comment-text" date-comment="${`${e.getFullYear()}${("0"+(e.getMonth()+1)).slice(-2)}${("0"+e.getDate()).slice(-2)}-${("0"+e.getHours()).slice(-2)}${("0"+e.getMinutes()).slice(-2)}${("0"+e.getSeconds()).slice(-2)}`}">Comment</span></span>`;t.replaceSelection(s);let n=t.getCursor(),o={line:n.line,ch:n.ch-14-7},l={line:n.line,ch:n.ch-14};t.setSelection(o,l)}}),gt(this),gt(this),this.addCommand({id:"mark-tag-choose",name:"Mark selection with <mark>\u2026",editorCallback:t=>{new Ht(this).open()}}),this.addCommand({id:"rebuild-mark-commands",name:"Rebuild mark commands (palette)",callback:()=>{this.registerMarkCommands(),new E.Notice("Mark commands rebuilt")}}),(this.settings.extraColors||[]).forEach((t,e)=>{let i=t.name||`Highlight ${e+1}`,s=this._slugifyName(i);this.addCommand({id:`mark-tag-${s||e}`,name:`Mark selection with <mark>: ${i}`,editorCallback:n=>this._applyMarkToSelection(n,{name:i,ui:t.ui,doc:t.doc||t.ui})})}),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.collections=new Map(Object.entries(this.settings.collections||{})),this.collectionsManager=new kt(this),this.inlineFootnoteManager=new ht,"registerHoverLinkSource"in this.app.workspace&&this.app.workspace.registerHoverLinkSource("sidebar-highlights",{display:"Sidebar Highlights",defaultMod:!0}),this.registerView(St,t=>(this.sidebarView=new bt(t,this),this.sidebarView)),this.addRibbonIcon("highlighter","Open highlights",()=>{this.activateView()}),this.addCommand({id:"create-highlight",name:"Create highlight from selection",editorCallback:t=>{this.createHighlight(t)}}),this.addCommand({id:"open-highlights-sidebar",name:"Toggle",callback:()=>{this.toggleView()}}),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,i)=>{e.getSelection()&&t.addItem(s=>{s.setTitle("Create highlight").setIcon("highlighter").onClick(()=>{this.createHighlight(e)})})})),this.registerEvent(this.app.workspace.on("file-open",t=>{t?this.loadHighlightsFromFile(t):(this.selectedHighlightId=null,this.sidebarView&&this.sidebarView.updateContent())})),this.registerEvent(this.app.workspace.on("editor-change",(t,e)=>{e instanceof E.MarkdownView&&this.debounceDetectMarkdownHighlights(t,e)})),this.addSettingTab(new Lt(this.app,this)),this.addStyles(),this.registerCollectionCommands(),this.app.workspace.onLayoutReady(async()=>{await this.fixDuplicateTimestamps(),this.scanAllFilesForHighlights(),await this.checkAndRescanForCommentTypes(),this.updateCustomColorStyles(),this.registerEvent(this.app.vault.on("create",t=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileCreate(t)})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileRename(t,e)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileDelete(t)}))})}onunload(){}async loadSettings(){let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==ot.settingsVersion?await this.migrateSettings(t):(this.settings=Object.assign({},ot,t),this.settings.settingsVersion||(this.settings.settingsVersion=ot.settingsVersion,await this.saveSettings()))}async saveSettings(){this.settings.highlights=Object.fromEntries(this.highlights),this.settings.collections=Object.fromEntries(this.collections),await this.saveData(this.settings),this.updateStyles()}addStyles(){let t=document.createElement("style");t.id="highlight-comments-plugin-styles",this.applyHighlightTheme(),this.updateCustomColorStyles(),document.head.appendChild(t)}updateStyles(){this.applyHighlightTheme(),this.updateCustomColorStyles()}removeStyles(){let t=document.getElementById("highlight-comments-plugin-styles");t&&t.remove();let e=document.getElementById("highlight-comments-custom-colors");e&&e.remove(),this.removeHighlightTheme()}applyHighlightTheme(){this.removeHighlightTheme();let t=this.getHighlightThemeClass(this.settings.highlightColor);document.body.classList.add(t)}removeHighlightTheme(){["theme-highlight-default","theme-highlight-yellow","theme-highlight-red","theme-highlight-teal","theme-highlight-blue","theme-highlight-green"].forEach(e=>{document.body.classList.remove(e)}),document.body.style.removeProperty("--theme-highlight-color")}getHighlightThemeClass(t){return{[this.settings.customColors.yellow]:"theme-highlight-yellow",[this.settings.customColors.red]:"theme-highlight-red",[this.settings.customColors.teal]:"theme-highlight-teal",[this.settings.customColors.blue]:"theme-highlight-blue",[this.settings.customColors.green]:"theme-highlight-green"}[t]||"theme-highlight-default"}updateCustomColorStyles(){let t=document.getElementById("highlight-comments-custom-colors");t&&t.remove();let e=document.createElement("style");e.id="highlight-comments-custom-colors";let i=`
            /* Dynamic hover color options */
            .hover-color-option[data-color="${this.settings.customColors.yellow}"] { background-color: ${this.settings.customColors.yellow} !important; }
            .hover-color-option[data-color="${this.settings.customColors.red}"] { background-color: ${this.settings.customColors.red} !important; }
            .hover-color-option[data-color="${this.settings.customColors.teal}"] { background-color: ${this.settings.customColors.teal} !important; }
            .hover-color-option[data-color="${this.settings.customColors.blue}"] { background-color: ${this.settings.customColors.blue} !important; }
            .hover-color-option[data-color="${this.settings.customColors.green}"] { background-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic group color squares */
            .group-color-square[data-color="${this.settings.customColors.yellow}"] { background-color: ${this.settings.customColors.yellow} !important; }
            .group-color-square[data-color="${this.settings.customColors.red}"] { background-color: ${this.settings.customColors.red} !important; }
            .group-color-square[data-color="${this.settings.customColors.teal}"] { background-color: ${this.settings.customColors.teal} !important; }
            .group-color-square[data-color="${this.settings.customColors.blue}"] { background-color: ${this.settings.customColors.blue} !important; }
            .group-color-square[data-color="${this.settings.customColors.green}"] { background-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic highlight theme colors */
            body.theme-highlight-yellow .cm-highlight { background-color: ${this.settings.customColors.yellow}66 !important; }
            body.theme-highlight-red .cm-highlight { background-color: ${this.settings.customColors.red}66 !important; }
            body.theme-highlight-teal .cm-highlight { background-color: ${this.settings.customColors.teal}66 !important; }
            body.theme-highlight-blue .cm-highlight { background-color: ${this.settings.customColors.blue}66 !important; }
            body.theme-highlight-green .cm-highlight { background-color: ${this.settings.customColors.green}66 !important; }
            
            /* Dynamic highlight card border colors */
            .highlight-item-card.highlight-color-yellow { border-left-color: ${this.settings.customColors.yellow} !important; }
            .highlight-item-card.highlight-color-red { border-left-color: ${this.settings.customColors.red} !important; }
            .highlight-item-card.highlight-color-teal { border-left-color: ${this.settings.customColors.teal} !important; }
            .highlight-item-card.highlight-color-blue { border-left-color: ${this.settings.customColors.blue} !important; }
            .highlight-item-card.highlight-color-green { border-left-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic highlight card selection colors */
            .highlight-item-card.highlight-color-yellow.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.yellow}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-red.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.red}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-teal.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.teal}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-blue.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.blue}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-green.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.green}, var(--shadow-s) !important; }
            
            /* Dynamic font sizes */
            .highlight-quote { font-size: ${this.settings.highlightFontSize}px !important; }
            .highlight-actions, .highlight-filename, .highlight-stats-section, .highlight-timestamp-info, .comment-buttons, .highlight-info-line { font-size: ${this.settings.detailsFontSize}px !important; }
            .highlight-comment { font-size: ${this.settings.commentFontSize}px !important; }
        `;e.textContent=i,document.head.appendChild(e)}async activateView(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(St);i.length>0?e=i[0]:(e=this.settings.sidebarPosition==="left"?t.getLeftLeaf(!1):t.getRightLeaf(!1),await(e==null?void 0:e.setViewState({type:St,active:!0}))),e&&t.revealLeaf(e)}async toggleView(){let{workspace:t}=this.app,e=t.getLeavesOfType(St);e.length>0?e.forEach(i=>i.detach()):await this.activateView()}async createHighlight(t){let e=t.getSelection();if(!e){new E.Notice("Please select some text first");return}let i=this.app.workspace.getActiveFile();if(!i){new E.Notice("No active file");return}let s=t.getCursor("from"),n=t.getCursor("to"),o=t.posToOffset(s),l=t.posToOffset(n),h={id:this.generateId(),text:e,tags:[],line:s.line,startOffset:o,endOffset:l,filePath:i.path,createdAt:Date.now()},a=this.highlights.get(i.path)||[];a.push(h),this.highlights.set(i.path,a);let g=`==${e}==`;t.replaceSelection(g),this.sidebarView&&this.sidebarView.setPreservePagination(!0),this.refreshSidebar(),new E.Notice("Highlight created")}refreshSidebar(){this.sidebarView&&this.sidebarView.refresh()}async reloadAllSettings(){await this.loadSettings(),this.addCommand({id:"insert-hover-comment-anchor",name:'Insert Comment Anchor (<span class="comment-anchor">\u2026</span>)',editorCallback:t=>{let e='<span class="comment-anchor"><span class="comment-text">CommentPlaceHolder</span></span>';t.replaceSelection(e)}}),gt(this),gt(this),this.addCommand({id:"mark-tag-choose",name:"Mark selection with <mark>\u2026",editorCallback:t=>{new Ht(this).open()}}),(this.settings.extraColors||[]).forEach((t,e)=>{let i=t.name||`Highlight ${e+1}`,s=this._slugifyName(i);this.addCommand({id:`mark-tag-${s||e}`,name:`Mark selection with <mark>: ${i}`,editorCallback:n=>this._applyMarkToSelection(n,{name:i,ui:t.ui,doc:t.doc||t.ui})})}),this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.registerCollectionCommands(),this.updateStyles(),this.refreshSidebar()}async createBackup(t){try{let e=new Date().toISOString().replace(/[:.]/g,"-"),i=`data-backup-${t}-${e}.json`,s={settingsVersion:this.settings.settingsVersion,collections:this.settings.collections,customColorNames:this.settings.customColorNames,highlights:this.settings.highlights,backupReason:t,originalTimestamp:e,backupCreatedAt:Date.now()},n=`.obsidian/plugins/sidebar-highlights/${i}`;await this.app.vault.adapter.write(n,JSON.stringify(s,null,2)),(t==="migration"||t==="manual")&&new E.Notice(`Settings backup created: ${i}`)}catch(e){console.error("Failed to create backup:",e),new E.Notice("Warning: Could not create settings backup")}}async migrateSettings(t){try{await this.createBackup("migration");let e=t.settingsVersion||"1.13.0",i=ot.settingsVersion;e!==i&&new E.Notice(`Migrating settings from ${e} to ${i}...`);let s=t.collections||{},n=t.customColorNames||{},o=t.highlights||{};this.settings={...ot},this.settings.collections=s,this.settings.customColorNames={...ot.customColorNames,...n},this.settings.highlights=o,t.highlightColor!==void 0&&(this.settings.highlightColor=t.highlightColor),t.sidebarPosition!==void 0&&(this.settings.sidebarPosition=t.sidebarPosition),t.groupingMode!==void 0&&(this.settings.groupingMode=t.groupingMode),t.showFilenames!==void 0&&(this.settings.showFilenames=t.showFilenames),t.showTimestamps!==void 0&&(this.settings.showTimestamps=t.showTimestamps),t.showHighlightActions!==void 0&&(this.settings.showHighlightActions=t.showHighlightActions),t.showToolbar!==void 0&&(this.settings.showToolbar=t.showToolbar),t.useInlineFootnotes!==void 0&&(this.settings.useInlineFootnotes=t.useInlineFootnotes),t.selectTextOnCommentClick!==void 0&&(this.settings.selectTextOnCommentClick=t.selectTextOnCommentClick),t.excludeExcalidraw!==void 0&&(this.settings.excludeExcalidraw=t.excludeExcalidraw),t.excludedFiles!==void 0&&(this.settings.excludedFiles=t.excludedFiles),t.dateFormat!==void 0&&(t.dateFormat==="YYYY-MM-DD HH:mm"?this.settings.dateFormat="YYYY-MM-DD HH:mm:ss":this.settings.dateFormat=t.dateFormat),t.customColors!==void 0&&(this.settings.customColors={...ot.customColors,...t.customColors}),this.settings.settingsVersion=i,this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),await this.saveSettings(),e!==i&&(new E.Notice(`Settings successfully migrated to ${i}`),await this.validateCollectionReferences())}catch(e){console.error("Migration failed:",e),new E.Notice("Error during settings migration. Please check console for details.")}}async validateCollectionReferences(){try{let t=new Set;for(let s of this.highlights.values())s.forEach(n=>t.add(n.id));let e=0,i=[];for(let s of this.collections.values()){let n=s.highlightIds.filter(o=>!t.has(o));n.length>0&&(e+=n.length,i.push({name:s.name,brokenCount:n.length,totalCount:s.highlightIds.length}),s.highlightIds=s.highlightIds.filter(o=>t.has(o)))}if(e>0){let s=i.map(n=>`\u2022 ${n.name}: ${n.brokenCount}/${n.totalCount} references`).join(`
`);new E.Notice(`Migration complete, but ${e} highlight reference(s) couldn't be restored:

${s}

Broken references have been cleaned up. You may need to manually re-add some highlights to these collections.`,8e3),console.log("Collection validation results:",{totalBrokenReferences:e,collectionsWithIssues:i,message:"Some highlight references were lost during migration, likely due to file changes. Automatic cleanup completed."}),await this.saveSettings()}else new E.Notice("Migration successful! All collections and highlights preserved.",3e3)}catch(t){console.error("Collection validation failed:",t),new E.Notice("Warning: Could not validate collection references after migration.")}}async onExternalSettingsChange(){try{await this.createBackup("external-sync");let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==ot.settingsVersion?await this.migrateSettings(t):await this.reloadAllSettings()}catch(t){console.error("Error handling external settings change:",t),await this.reloadAllSettings()}}registerCollectionCommands(){for(let t of this.collections.values()){let e=`go-to-collection-${t.id}`;this.addCommand({id:e,name:`Go to ${t.name}`,callback:()=>{this.goToCollection(t.id)}}),this.collectionCommands.add(e)}}unregisterCollectionCommands(){for(let t of this.collectionCommands)this.removeCommand(t);this.collectionCommands.clear()}async goToCollection(t){await this.activateView(),this.sidebarView&&this.sidebarView.navigateToCollection(t)}updateHighlight(t,e,i){let s=i,n;if(s)n=this.highlights.get(s);else for(let[l,c]of this.highlights)if(c.some(h=>h.id===t)){s=l,n=c;break}if(!s&&!i){let l=this.app.workspace.getActiveFile();l&&(s=l.path,n=this.highlights.get(s))}if(!s||!n)return;let o=n.findIndex(l=>l.id===t);if(o!==-1){let l={...n[o],...e},c=[...n];c[o]=l,this.highlights.set(s,c),this.saveSettings(),this.sidebarView&&this.sidebarView.updateItem(t)}}async loadHighlightsFromFile(t){if(this.selectedHighlightId?(this.highlights.get(t.path)||[]).find(n=>n.id===this.selectedHighlightId)||(this.selectedHighlightId=null):this.selectedHighlightId=null,!this.shouldProcessFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}if(await this.isExcalidrawFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t),this.sidebarView&&this.sidebarView.updateContent()}debounceDetectMarkdownHighlights(t,e){this.detectHighlightsTimeout&&window.clearTimeout(this.detectHighlightsTimeout),this.detectHighlightsTimeout=window.setTimeout(()=>{this.detectMarkdownHighlights(t,e)},1e3)}async detectMarkdownHighlights(t,e){let i=e.file;if(!i)return;let s=t.getValue();this.detectAndStoreMarkdownHighlights(s,i)}async scanAllFilesForHighlights(){let e=this.app.vault.getMarkdownFiles().filter(n=>this.shouldProcessFile(n)),i=new Set(e.map(n=>n.path)),s=!1;for(let n of this.highlights.keys())i.has(n)||(this.highlights.delete(n),s=!0);for(let n of this.collections.values()){let o=n.highlightIds.length;n.highlightIds=n.highlightIds.filter(l=>{for(let[c,h]of this.highlights)if(h.some(a=>a.id===l))return!0;return!1}),n.highlightIds.length!==o&&(s=!0)}for(let n of e)try{if(await this.isExcalidrawFile(n)){this.highlights.has(n.path)&&(this.highlights.delete(n.path),s=!0);continue}let o=await this.app.vault.read(n),l=this.highlights.get(n.path)||[];this.detectAndStoreMarkdownHighlights(o,n,!1);let c=this.highlights.get(n.path)||[],h=d=>{var u;return{id:d.id,start:d.startOffset,end:d.endOffset,text:d.text,footnotes:d.footnoteCount,contents:((u=d.footnoteContents)!=null?u:[]).filter(m=>m.trim()!=="").join(`
`),color:d.color,isNativeComment:d.isNativeComment,createdAt:typeof d.createdAt=="number"&&!Number.isNaN(d.createdAt)?d.createdAt:null,commentTimestamps:Array.isArray(d.commentTimestamps)?d.commentTimestamps.filter(m=>typeof m=="number"&&!Number.isNaN(m)):[]}},a=JSON.stringify(l.map(h)),g=JSON.stringify(c.map(h));a!==g&&(s=!0)}catch(o){}s&&(await this.saveSettings(),this.refreshSidebar())}async checkAndRescanForCommentTypes(){let t=!1;for(let[e,i]of this.highlights){for(let s of i)if(s.footnoteContents&&s.footnoteContents.length>0&&!s.commentTypes){t=!0;break}if(t)break}t&&(console.log("Sidebar Highlights: Detected highlights without comment types, re-scanning..."),this.highlights.clear(),await this.scanAllFilesForHighlights())}parseHtmlColor(t){let e=t.trim().toLowerCase(),i={yellow:"#ffff00",red:"#ff0000",green:"#008000",blue:"#0000ff",orange:"#ffa500",purple:"#800080",pink:"#ffc0cb",cyan:"#00ffff",magenta:"#ff00ff",lime:"#00ff00",brown:"#a52a2a",gray:"#808080",grey:"#808080",black:"#000000",white:"#ffffff"};return i[e]?i[e]:/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(e)?e.length===4?"#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]:e:null}getCssClassColor(t){try{let e=document.createElement("span");e.className=t,e.style.visibility="hidden",e.style.position="absolute",document.body.appendChild(e);let s=window.getComputedStyle(e).backgroundColor;return document.body.removeChild(e),this.rgbaToHex(s)}catch(e){return null}}rgbaToHex(t){if(!t||t==="transparent"||t==="rgba(0, 0, 0, 0)")return null;let e=t.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*([\d.]+))?\s*\)/);if(!e)return null;let i=parseInt(e[1],10),s=parseInt(e[2],10),n=parseInt(e[3],10),o=e[4]?parseFloat(e[4]):1,l=h=>h.toString(16).padStart(2,"0"),c=`#${l(i)}${l(s)}${l(n)}`;if(o<1){let h=Math.round(o*255).toString(16).padStart(2,"0");return c+h}return c}stripHtmlToText(t){let e=document.createElement("template");return e.innerHTML=t||"",(e.content.textContent||"").replace(/\s+/g," ").trim()}parseNestedMarks(t){let e=[],i=[],s=/<\/?mark\b[^>]*>/gi,n,o=l=>{var a,g,d,u;return((u=(d=((g=(a=l.match(/style\s*=\s*["']([^"']+)["']/i))==null?void 0:a[1])!=null?g:"").match(/background(?:-color)?:\s*([^;]+)/i))==null?void 0:d[1])==null?void 0:u.trim())||void 0};for(;(n=s.exec(t))!==null;){let l=n[0];if(!/^<\/mark/i.test(l))i.push({start:n.index,open:l,openEnd:n.index+l.length,children:[]});else if(i.length){let h=i.pop(),a=n.index+l.length,g=t.slice(h.openEnd,n.index),d=document.createElement("template");d.innerHTML=g;let u=(d.content.textContent||"").replace(/\s+/g," ").trim(),m=o(h.open),p={start:h.start,end:a,text:u,color:m,children:h.children};i.length?i[i.length-1].children.push(p):e.push(p)}}return e}detectAndStoreMarkdownHighlights(t,e,i=!0){var b,M,N,F,$,A;let s=/==([^=\n](?:[^=\n]|=[^=\n])*?[^=\n])==/g,n=/%%([^%](?:[^%]|%[^%])*?)%%/g,o=/<span\s+style=["'][^"']*background:\s*([^;"']+)[^"']*["'][^>]*>(.*?)<\/span>/gi,l=/<font\s+color=["']([^"']+)["'][^>]*>(.*?)<\/font>/gi,c=/<mark[^>]*>(.*?)<\/mark>/gi,h=/<span\s+class=["']([^"']+)["'][^>]*>(.*?)<\/span>/gi,a=[],g=new Set,d=[],u=this.highlights.get(e.path)||[],m=new Set,p=(v,y,L,k)=>{let T=u.find(B=>!m.has(B.id)&&B.text===v&&B.startOffset===y&&B.endOffset===L&&B.isNativeComment===k);if(T)return m.add(T.id),T;let P=u.find(B=>!m.has(B.id)&&B.text===v&&Math.abs(B.startOffset-y)<=50&&B.isNativeComment===k);if(P)return m.add(P.id),P;let U=u.find(B=>!m.has(B.id)&&B.text===v&&B.isNativeComment===k&&!u.some(q=>q!==B&&q.text===v&&q.isNativeComment===k));if(U)return m.add(U.id),U},C=this.extractFootnotes(t),w=this.getCodeBlockRanges(t),S=[],f;for(;(f=s.exec(t))!==null;)if(!this.isInsideCodeBlock(f.index,f.index+f[0].length,w)){let v=t.charAt(f.index-1),y=t.charAt(f.index+f[0].length);if(v==="="||y==="=")continue;S.push({match:f,type:"highlight"})}for(;(f=n.exec(t))!==null;)if(!this.isInsideCodeBlock(f.index,f.index+f[0].length,w)){let v=t.charAt(f.index-1),y=t.charAt(f.index+f[0].length);if(v==="%"||y==="%")continue;S.push({match:f,type:"comment"})}for(;(f=o.exec(t))!==null;)if(!this.isInsideCodeBlock(f.index,f.index+f[0].length,w)){let v=this.parseHtmlColor(f[1]);if(v){let y=Object.assign([],f);y[1]=f[2],S.push({match:y,type:"html",color:v})}}for(;(f=l.exec(t))!==null;)if(!this.isInsideCodeBlock(f.index,f.index+f[0].length,w)){let v=this.parseHtmlColor(f[1]);if(v){let y=Object.assign([],f);y[1]=f[2],S.push({match:y,type:"html",color:v})}}for(;(f=c.exec(t))!==null;)if(!this.isInsideCodeBlock(f.index,f.index+f[0].length,w)){let v=f[0].indexOf(">")+1,y=f[0].slice(0,v),T=((F=(N=((M=(b=y.match(/style\s*=\s*["']([^"']+)["']/i))==null?void 0:b[1])!=null?M:"").match(/background(?:-color)?:\s*([^;]+)/i))==null?void 0:N[1])==null?void 0:F.trim())||"#ffff00",U=(((A=($=y.match(/class\s*=\s*["']([^"']+)["']/i))==null?void 0:$[1])!=null?A:"").split(/\s+/).find(z=>/^sbh-/i.test(z))||"").replace(/^sbh-/i,"").toLowerCase();if(/<mark\b/i.test(f[1]))continue;let B=Object.assign([],f),q=document.createElement("template");q.innerHTML=f[1];let Y=(q.content.textContent||"").replace(/\s+/g," ").trim();B[1]=Y,S.push({match:B,type:"html",color:T,cls:U})}for(;(f=h.exec(t))!==null;)if(!this.isInsideCodeBlock(f.index,f.index+f[0].length,w)){let v=f[1].trim(),y=this.getCssClassColor(v);if(y){let L=Object.assign([],f);L[1]=f[2],S.push({match:L,type:"html",color:y})}}S.sort((v,y)=>v.match.index-y.match.index),function(){var T,P,U,B,q,Y,z,R;let y=(V,O)=>`${V}:${O}`,L=new Set;for(let V of S){if(!V||!V.match)continue;let O=V.match.index,G=V.match.index+V.match[0].length;L.add(y(O,G))}let k=this.parseNestedMarks(t);for(let V of k){let O=V.start,G=V.end;if(!this.isInsideCodeBlock(O,G,w)){if(!L.has(y(O,G))){let K=[],J=(((U=(P=(((T=t.slice(O,G).match(/<mark\b[^>]*>/i))==null?void 0:T[0])||"").match(/class\s*=\s*["']([^"']+)["']/i))==null?void 0:P[1])!=null?U:"").split(/\s+/).find(X=>/^sbh-/i.test(X))||"").replace(/^sbh-/i,"").toLowerCase();K.index=O,K[0]=t.slice(O,G),K[1]=V.text,S.push({match:K,type:"html",color:(B=V.color)!=null?B:"#ffff00",cls:J}),L.add(y(O,G))}if(V.children&&V.children.length){let K=V.children[0],j=K.start,Z=K.end;if(!this.isInsideCodeBlock(j,Z,w)&&!L.has(y(j,Z))){let J=[],nt=(((z=(Y=(((q=t.slice(j,Z).match(/<mark\b[^>]*>/i))==null?void 0:q[0])||"").match(/class\s*=\s*["']([^"']+)["']/i))==null?void 0:Y[1])!=null?z:"").split(/\s+/).find(W=>/^sbh-/i.test(W))||"").replace(/^sbh-/i,"").toLowerCase();J.index=j,J[0]=t.slice(j,Z),J[1]=K.text,S.push({match:J,type:"html",color:(R=K.color)!=null?R:"#ffff00",cls:nt}),L.add(y(j,Z))}}}}}.call(this),S.forEach(({match:v,type:y,color:L,cls:k})=>{let[,T]=v;if(!T||T.trim()==="")return;let P=p(T,v.index,v.index+v[0].length,y==="comment"),U=t.substring(0,v.index).split(`
`).length-1,B=[],q=0,Y=[],z=[];if(y==="highlight"||y==="html"){let V=t.substring(v.index+v[0].length),O=[],G=0,K=/^\s*\^\[([^\]]+)\]/,j=/^\s*\[\^([a-zA-Z0-9_-]+)\](?!:)/,Z=/^\s*<span\s+class=["']comment-anchor["'][^>]*>\s*<span\s+class=["']comment-text["']([^>]*)>([\s\S]*?)<\/span>\s*<\/span>/i;t:for(;G<V.length;){let W=V.slice(G),tt=W.match(/^\s+/);if(tt){G+=tt[0].length;continue}let lt=W.match(Z);if(lt){let it=v.index+v[0].length+G,ut=it+lt[0].length,Pt=document.createElement("template");Pt.innerHTML=lt[2]||"";let Ft=(Pt.content.textContent||"").replace(/\s+/g," ").trim();if(Ft){let Dt,$t=lt[1].match(/date-comment\s*=\s*["'](\d{8}-\d{6})["']/i);if($t){let at=$t[1],Ot=Number(at.slice(0,4)),Bt=Number(at.slice(4,6))-1,Vt=Number(at.slice(6,8)),zt=Number(at.slice(9,11)),Gt=Number(at.slice(11,13)),_t=Number(at.slice(13,15));Dt=new Date(Ot,Bt,Vt,zt,Gt,_t).getTime()}O.push({type:"anchor",index:it,content:Ft,timestamp:Dt}),g.add(it),d.push([it,ut])}G+=lt[0].length;continue}let Nt=W.match(K);if(Nt){let it=(Nt[1]||"").trim();it&&O.push({type:"inline",index:v.index+v[0].length+G,content:it}),G+=Nt[0].length;continue}let At=W.match(j);if(At){let it=At[1];if(C.has(it)){let ut=(C.get(it)||"").trim();ut&&O.push({type:"standard",index:v.index+v[0].length+G,content:ut})}G+=At[0].length;continue}break t}O.sort((W,tt)=>W.index-tt.index);let J=[],X=new Set;for(let W of O)X.has(W.index)||(X.add(W.index),J.push(W));let rt=new Set,nt=J.filter(W=>{let tt=(W.content||"").trim();return rt.has(tt)?!1:(rt.add(tt),!0)});B=nt.map(W=>W.content),Y=nt.map(W=>W.timestamp).filter(W=>W!==void 0),z=nt.map(W=>W.type),q=B.length}else y==="comment"&&(B=[T],q=1);if(!d.some(([V,O])=>v.index>=V&&v.index<O))if(P)a.push({...P,line:U,startOffset:v.index,endOffset:v.index+v[0].length,filePath:e.path,footnoteCount:q,footnoteContents:B,commentTimestamps:Y.length>0?Y:P.commentTimestamps,commentTypes:z.length>0?z:P.commentTypes,isNativeComment:y==="comment",color:y==="html"?L:P.color,createdAt:function(){var V,O,G;try{if(y==="html"){let K=((V=v[0].match(/<mark\b[^>]*>/i))==null?void 0:V[0])||"",j=(O=K.match(/date-highlight\s*=\s*["'](\d{8}-\d{6})["']/i))==null?void 0:O[1],Z=(G=K.match(/data-highlight-ts\s*=\s*["'](\d+)["']/i))==null?void 0:G[1];if(j&&/^\d{8}-\d{6}$/.test(j)){let J=Number(j.slice(0,4)),X=Number(j.slice(4,6))-1,rt=Number(j.slice(6,8)),nt=Number(j.slice(9,11)),W=Number(j.slice(11,13)),tt=Number(j.slice(13,15));return new Date(J,X,rt,nt,W,tt).getTime()}else if(Z){let J=Number(Z);if(!Number.isNaN(J))return J}}}catch(K){}return P.createdAt||Date.now()}(),type:y,markClassSlug:k||(y==="html"?k:void 0)});else{let V=e.stat.mtime+v.index%1e3;a.push({id:this.generateId(),text:T,tags:[],line:U,startOffset:v.index,endOffset:v.index+v[0].length,filePath:e.path,footnoteCount:q,footnoteContents:B,commentTimestamps:Y.length>0?Y:void 0,commentTypes:z.length>0?z:void 0,createdAt:function(){var O,G,K;try{if(y==="html"){let j=((O=v[0].match(/<mark\b[^>]*>/i))==null?void 0:O[0])||"",Z=(G=j.match(/date-highlight\s*=\s*["'](\d{8}-\d{6})["']/i))==null?void 0:G[1],J=(K=j.match(/data-highlight-ts\s*=\s*["'](\d+)["']/i))==null?void 0:K[1];if(Z&&/^\d{8}-\d{6}$/.test(Z)){let X=Number(Z.slice(0,4)),rt=Number(Z.slice(4,6))-1,nt=Number(Z.slice(6,8)),W=Number(Z.slice(9,11)),tt=Number(Z.slice(11,13)),lt=Number(Z.slice(13,15));return new Date(X,rt,nt,W,tt,lt).getTime()}else if(J){let X=Number(J);if(!Number.isNaN(X))return X}}}catch(j){}return V}(),isNativeComment:y==="comment",color:y==="html"?L:void 0,type:y,markClassSlug:k})}});{let v=/<span\s+class=["']comment-anchor["'][^>]*>\s*<span\s+class=["']comment-text["'][^>]*>([\s\S]*?)<\/span>\s*<\/span>/gi,y;for(;(y=v.exec(t))!==null;){if(g.has(y.index)||this.isInsideCodeBlock(y.index,y.index+y[0].length,w))continue;let L=document.createElement("template");L.innerHTML=y[1]||"";let k=(L.content.textContent||"").replace(/\s+/g," ").trim();if(!k)continue;let T=t.substring(0,y.index).split(`
`).length-1;a.push({id:`${Date.now()}_${Math.random().toString(36).slice(2)}`,text:k,tags:[],line:T,startOffset:y.index,endOffset:y.index+y[0].length,filePath:e.path,footnoteCount:1,footnoteContents:[k],isNativeComment:!0,color:void 0,createdAt:Date.now(),type:"comment"})}}let D=v=>{var y;return{id:v.id,start:v.startOffset,end:v.endOffset,text:v.text,footnotes:v.footnoteCount,contents:((y=v.footnoteContents)!=null?y:[]).filter(L=>L.trim()!=="").join(`
`),color:v.color,isNativeComment:v.isNativeComment,createdAt:typeof v.createdAt=="number"&&!Number.isNaN(v.createdAt)?v.createdAt:null,commentTimestamps:Array.isArray(v.commentTimestamps)?v.commentTimestamps.filter(L=>typeof L=="number"&&!Number.isNaN(L)):[]}},H=JSON.stringify(u.map(D)),I=JSON.stringify(a.map(D));H!==I&&(this.highlights.set(e.path,a),i&&(this.saveSettings(),this.smartUpdateSidebar(u,a)))}smartUpdateSidebar(t,e){var c,h;if(!this.sidebarView)return;let i=new Map,s=new Map;t.forEach(a=>i.set(a.id,a)),e.forEach(a=>s.set(a.id,a));let n=new Set(i.keys()),o=new Set(s.keys());if(n.size!==o.size||[...n].some(a=>!o.has(a))||[...o].some(a=>!n.has(a)))this.refreshSidebar();else for(let[a,g]of s){let d=i.get(a);if(d){let u=JSON.stringify({text:d.text,footnotes:d.footnoteCount,contents:(c=d.footnoteContents)==null?void 0:c.filter(p=>p.trim()!==""),color:d.color,isNativeComment:d.isNativeComment}),m=JSON.stringify({text:g.text,footnotes:g.footnoteCount,contents:(h=g.footnoteContents)==null?void 0:h.filter(p=>p.trim()!==""),color:g.color,isNativeComment:g.isNativeComment});u!==m&&this.sidebarView.updateItem(a)}}}extractFootnotes(t){let e=new Map,i=/^\[\^(\w+)\]:\s*(.+)$/gm,s;for(;(s=i.exec(t))!==null;){let[,n,o]=s;e.set(n,o.trim())}return e}async handleFileCreate(t){try{let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t,!1);let i=this.highlights.get(t.path);i&&i.length>0&&(await this.saveSettings(),this.refreshSidebar())}catch(e){}}async handleFileRename(t,e){let i=this.highlights.get(e);if(i&&i.length>0){let s=i.map(n=>({...n,filePath:t.path}));this.highlights.delete(e),this.highlights.set(t.path,s),await this.saveSettings(),this.refreshSidebar()}}handleFileDelete(t){if(this.highlights.has(t.path)){let e=new Set((this.highlights.get(t.path)||[]).map(s=>s.id));this.highlights.delete(t.path);let i=!1;for(let s of this.collections.values()){let n=s.highlightIds.length;s.highlightIds=s.highlightIds.filter(o=>!e.has(o)),s.highlightIds.length!==n&&(i=!0)}this.saveSettings(),this.refreshSidebar()}}getCurrentFileHighlights(){let t=this.app.workspace.getActiveFile();return t?this.highlights.get(t.path)||[]:[]}generateId(){return Math.random().toString(36).substr(2,9)}shouldProcessFile(t){return!(t.extension!=="md"||this.settings.excludeExcalidraw&&t.name.endsWith(".excalidraw.md")||this.isFileExcluded(t.path))}isFileExcluded(t){if(!this.settings.excludedFiles||this.settings.excludedFiles.length===0)return!1;let e=t.replace(/\\/g,"/");for(let i of this.settings.excludedFiles){let s=i.replace(/\\/g,"/");if(e===s||e.startsWith(s+"/"))return!0}return!1}async isExcalidrawFile(t){if(!this.settings.excludeExcalidraw)return!1;if(t.name.endsWith(".excalidraw.md"))return!0;try{let i=(await this.app.vault.read(t)).match(/^---\n([\s\S]*?)\n---/);if(i){let s=i[1];if(/excalidraw-plugin:\s*parsed/i.test(s)||/tags:\s*\[.*excalidraw.*\]/i.test(s))return!0}}catch(e){}return!1}async fixDuplicateTimestamps(){let t=!1;for(let[e,i]of this.highlights){let s=new Map;i.forEach(n=>{n.createdAt&&(s.has(n.createdAt)||s.set(n.createdAt,[]),s.get(n.createdAt).push(n))});for(let[n,o]of s)o.length>1&&(o.sort((l,c)=>l.startOffset-c.startOffset),o.forEach((l,c)=>{c>0&&(l.createdAt=n+c,t=!0)}))}t&&(await this.saveSettings(),this.refreshSidebar())}getCodeBlockRanges(t){let e=[],i=/^```[\s\S]*?\n```\s*$/gm,s=/^~~~[\s\S]*?\n~~~\s*$/gm,n;for(;(n=i.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});for(;(n=s.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});let o=/`([^`\n]+?)`/g;for(;(n=o.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});return e}isInsideCodeBlock(t,e,i){return i.some(s=>t>=s.start&&e<=s.end)}},Lt=class extends E.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new E.Setting(t).setHeading().setName("Display"),new E.Setting(t).setName("Show note titles in all notes and collections").setDesc("Display the filename/note title below highlights when viewing All Notes or Collections.").addToggle(a=>a.setValue(this.plugin.settings.showFilenames).onChange(async g=>{this.plugin.settings.showFilenames=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show note timestamps").setDesc("Display creation timestamps for highlights.").addToggle(a=>a.setValue(this.plugin.settings.showTimestamps).onChange(async g=>{this.plugin.settings.showTimestamps=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show highlight actions").setDesc("Display the actions area below each highlight (filename, stats, and buttons).").addToggle(a=>a.setValue(this.plugin.settings.showHighlightActions).onChange(async g=>{this.plugin.settings.showHighlightActions=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show toolbar").setDesc("Display the toolbar with search, grouping, and other action buttons.").addToggle(a=>a.setValue(this.plugin.settings.showToolbar).onChange(async g=>{this.plugin.settings.showToolbar=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Auto-unfold on focus").setDesc("Automatically unfold content when focusing highlights from the sidebar.").addToggle(a=>a.setValue(this.plugin.settings.autoToggleFold).onChange(async g=>{this.plugin.settings.autoToggleFold=g,await this.plugin.saveSettings()})),new E.Setting(t).setName("Date format").setDesc("Format string for timestamps using moment.js syntax (e.g., YYYY-MM-DD HH:mm, MMM DD YYYY, DD/MM/YYYY h:mm A).").addMomentFormat(a=>a.setValue(this.plugin.settings.dateFormat).setPlaceholder("YYYY-MM-DD HH:mm").onChange(async g=>{this.plugin.settings.dateFormat=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Minimum character count").setDesc("Hide highlights and native comments shorter than this character count from the sidebar (default 0).").addText(a=>a.setPlaceholder("0").setValue(this.plugin.settings.minimumCharacterCount.toString()).onChange(async g=>{let d=parseInt(g)||0;this.plugin.settings.minimumCharacterCount=Math.max(0,d),await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setHeading().setName("Typography"),new E.Setting(t).setName("Main highlight text").setDesc("Adjust main highlight text size (default 11).").addText(a=>a.setPlaceholder("11").setValue(this.plugin.settings.highlightFontSize.toString()).onChange(async g=>{let d=parseInt(g);!isNaN(d)&&d>=8&&d<=32&&(this.plugin.settings.highlightFontSize=d,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new E.Setting(t).setName("Details text size").setDesc("Adjust details text size (filename, line number, etc) (default 11).").addText(a=>a.setPlaceholder("11").setValue(this.plugin.settings.detailsFontSize.toString()).onChange(async g=>{let d=parseInt(g);!isNaN(d)&&d>=8&&d<=24&&(this.plugin.settings.detailsFontSize=d,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new E.Setting(t).setName("Comment text size").setDesc("Adjust comment text size (default 11).").addText(a=>a.setPlaceholder("11").setValue(this.plugin.settings.commentFontSize.toString()).onChange(async g=>{let d=parseInt(g);!isNaN(d)&&d>=8&&d<=24&&(this.plugin.settings.commentFontSize=d,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new E.Setting(t).setHeading().setName("Styling");let e=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.yellow.toUpperCase()}`).setDesc("Customize the first highlight color.").addColorPicker(a=>a.setValue(this.plugin.settings.customColors.yellow).onChange(async g=>{this.plugin.settings.customColors.yellow=g,await this.plugin.saveSettings(),this.updateColorMappings(),e.setName(`Highlight color: ${g.toUpperCase()}`)})).addButton(a=>a.setButtonText("Reset").setTooltip("Reset to default yellow (#ffd700)").onClick(async()=>{this.plugin.settings.customColors.yellow="#ffd700",await this.plugin.saveSettings(),this.updateColorMappings(),e.setName(`Highlight color: ${this.plugin.settings.customColors.yellow.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(a=>a.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.yellow).onChange(async g=>{this.plugin.settings.customColorNames.yellow=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let i=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.red.toUpperCase()}`).setDesc("Customize the second highlight color.").addColorPicker(a=>a.setValue(this.plugin.settings.customColors.red).onChange(async g=>{this.plugin.settings.customColors.red=g,await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(`Highlight color: ${g.toUpperCase()}`)})).addButton(a=>a.setButtonText("Reset").setTooltip("Reset to default red (#ff6b6b)").onClick(async()=>{this.plugin.settings.customColors.red="#ff6b6b",await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(`Highlight color: ${this.plugin.settings.customColors.red.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(a=>a.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.red).onChange(async g=>{this.plugin.settings.customColorNames.red=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let s=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.teal.toUpperCase()}`).setDesc("Customize the third highlight color.").addColorPicker(a=>a.setValue(this.plugin.settings.customColors.teal).onChange(async g=>{this.plugin.settings.customColors.teal=g,await this.plugin.saveSettings(),this.updateColorMappings(),s.setName(`Highlight color: ${g.toUpperCase()}`)})).addButton(a=>a.setButtonText("Reset").setTooltip("Reset to default teal (#4ecdc4)").onClick(async()=>{this.plugin.settings.customColors.teal="#4ecdc4",await this.plugin.saveSettings(),this.updateColorMappings(),s.setName(`Highlight color: ${this.plugin.settings.customColors.teal.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(a=>a.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.teal).onChange(async g=>{this.plugin.settings.customColorNames.teal=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let n=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.blue.toUpperCase()}`).setDesc("Customize the fourth highlight color.").addColorPicker(a=>a.setValue(this.plugin.settings.customColors.blue).onChange(async g=>{this.plugin.settings.customColors.blue=g,await this.plugin.saveSettings(),this.updateColorMappings(),n.setName(`Highlight color: ${g.toUpperCase()}`)})).addButton(a=>a.setButtonText("Reset").setTooltip("Reset to default blue (#45b7d1)").onClick(async()=>{this.plugin.settings.customColors.blue="#45b7d1",await this.plugin.saveSettings(),this.updateColorMappings(),n.setName(`Highlight color: ${this.plugin.settings.customColors.blue.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(a=>a.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.blue).onChange(async g=>{this.plugin.settings.customColorNames.blue=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let o=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.green.toUpperCase()}`).setDesc("Customize the fifth highlight color.").addColorPicker(a=>a.setValue(this.plugin.settings.customColors.green).onChange(async g=>{this.plugin.settings.customColors.green=g,await this.plugin.saveSettings(),this.updateColorMappings(),o.setName(`Highlight color: ${g.toUpperCase()}`)})).addButton(a=>a.setButtonText("Reset").setTooltip("Reset to default green (#96ceb4)").onClick(async()=>{this.plugin.settings.customColors.green="#96ceb4",await this.plugin.saveSettings(),this.updateColorMappings(),o.setName(`Highlight color: ${this.plugin.settings.customColors.green.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(a=>a.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.green).onChange(async g=>{this.plugin.settings.customColorNames.green=g,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setHeading().setName("Document colors (for in-document highlights)"),new E.Setting(t).setName("Yellow \u2014 document").addColorPicker(a=>a.setValue(this.plugin.settings.customColorsDoc.yellow).onChange(async g=>{this.plugin.settings.customColorsDoc.yellow=g,await this.plugin.saveSettings(),this.plugin.updateStyles()})),new E.Setting(t).setName("Red \u2014 document").addColorPicker(a=>a.setValue(this.plugin.settings.customColorsDoc.red).onChange(async g=>{this.plugin.settings.customColorsDoc.red=g,await this.plugin.saveSettings(),this.plugin.updateStyles()})),new E.Setting(t).setName("Teal \u2014 document").addColorPicker(a=>a.setValue(this.plugin.settings.customColorsDoc.teal).onChange(async g=>{this.plugin.settings.customColorsDoc.teal=g,await this.plugin.saveSettings(),this.plugin.updateStyles()})),new E.Setting(t).setName("Blue \u2014 document").addColorPicker(a=>a.setValue(this.plugin.settings.customColorsDoc.blue).onChange(async g=>{this.plugin.settings.customColorsDoc.blue=g,await this.plugin.saveSettings(),this.plugin.updateStyles()})),new E.Setting(t).setName("Green \u2014 document").addColorPicker(a=>a.setValue(this.plugin.settings.customColorsDoc.green).onChange(async g=>{this.plugin.settings.customColorsDoc.green=g,await this.plugin.saveSettings(),this.plugin.updateStyles()})),new E.Setting(t).setHeading().setName("Highlights palette");let l=t.createDiv({cls:"extra-colors-section"}),c=()=>{l.empty(),(this.plugin.settings.extraColors||[]).forEach((a,g)=>{let d=new E.Setting(l);d.settingEl.classList.add("extra-color-setting"),d.setName(`Highlight ${g+1}`).setDesc("Sidebar/UI vs Document color"),d.addColorPicker(u=>u.setValue(a.ui||"#cccccc").onChange(async m=>{this.plugin.settings.extraColors[g].ui=m,this.plugin.settings.extraColors[g].linked&&(this.plugin.settings.extraColors[g].doc=m),await this.plugin.saveSettings(),this.plugin.refreshSidebar()})).addColorPicker(u=>u.setValue(a.doc||a.ui||"#cccccc").onChange(async m=>{this.plugin.settings.extraColors[g].doc=m,this.plugin.settings.extraColors[g].linked=!1,await this.plugin.saveSettings(),this.plugin.updateStyles()})).addToggle(u=>u.setValue(!!a.linked).setTooltip("Link doc to UI").onChange(async m=>{this.plugin.settings.extraColors[g].linked=m,m&&(this.plugin.settings.extraColors[g].doc=this.plugin.settings.extraColors[g].ui),await this.plugin.saveSettings(),this.plugin.updateStyles()})).addText(u=>u.setPlaceholder("Name (optional)").setValue(a.name||"").onChange(async m=>{this.plugin.settings.extraColors[g].name=m,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})).addExtraButton(u=>u.setIcon("trash-2").setTooltip("Remove").onClick(async()=>{this.plugin.settings.extraColors.splice(g,1),await this.plugin.saveSettings(),c(),(()=>{let p=Array.from(t.querySelectorAll(".setting-item"));for(let C of p){let w=C.querySelector(".setting-item-name");if(!w)continue;let S=(w.textContent||"").toLowerCase().trim();(S.startsWith("highlight color")||S==="highlight name"||S.includes("document colors (for in-document highlights)")||S.endsWith("\u2014 document"))&&C.remove()}})(),this.plugin.refreshSidebar()}))})};c(),(()=>{let a=Array.from(t.querySelectorAll(".setting-item"));for(let g of a){let d=g.querySelector(".setting-item-name");if(!d)continue;let u=(d.textContent||"").toLowerCase().trim();(u.startsWith("highlight color")||u==="highlight name"||u.includes("document colors (for in-document highlights)")||u.endsWith("\u2014 document"))&&g.remove()}})(),new E.Setting(t).addButton(a=>a.setButtonText("Add color").onClick(async()=>{this.plugin.settings.extraColors=this.plugin.settings.extraColors||[],this.plugin.settings.extraColors.push({ui:"#cccccc",doc:"#cccccc",name:"",linked:!0}),await this.plugin.saveSettings(),c(),(()=>{let d=Array.from(t.querySelectorAll(".setting-item"));for(let u of d){let m=u.querySelector(".setting-item-name");if(!m)continue;let p=(m.textContent||"").toLowerCase().trim();(p.startsWith("highlight color")||p==="highlight name"||p.includes("document colors (for in-document highlights)")||p.endsWith("\u2014 document"))&&u.remove()}})()})),new E.Setting(t).addButton(a=>a.setButtonText("Add default colors").setTooltip("Insert the standard set (skips ones you already have)").onClick(async()=>{let g=m=>{let p=(m||"").replace("#","");return"#"+(p.length>=6?p.slice(0,6):p.padEnd(6,"0"))},d=m=>{let p=I=>{let b=I.replace("#",""),M=parseInt(b.slice(0,2),16)/255,N=parseInt(b.slice(2,4),16)/255,F=parseInt(b.slice(4,6),16)/255,$=Math.max(M,N,F),A=Math.min(M,N,F),v=0,y=0,L=($+A)/2;if($!==A){let k=$-A;switch(y=L>.5?k/(2-$-A):k/($+A),$){case M:v=(N-F)/k+(N<F?6:0);break;case N:v=(F-M)/k+2;break;case F:v=(M-N)/k+4;break}v/=6}return{h:v,s:y,l:L}},C=(I,b,M)=>{let N=(y,L,k)=>(k<0&&(k+=1),k>1&&(k-=1),k<.16666666666666666?y+(L-y)*6*k:k<.5?L:k<.6666666666666666?y+(L-y)*(.6666666666666666-k)*6:y),F,$,A;if(b===0)F=$=A=M;else{let y=M<.5?M*(1+b):M+b-M*b,L=2*M-y;F=N(L,y,I+.3333333333333333),$=N(L,y,I),A=N(L,y,I-.3333333333333333)}let v=y=>("0"+Math.round(y*255).toString(16)).slice(-2);return"#"+v(F)+v($)+v(A)},{h:w,s:S,l:f}=p(m),D=Math.min(1,S*1.15+.25),H=f;return f<.45&&(H=.55),f>.7&&(H=.6),C(w,D,H)},u=[{name:"KeyHighlight",doc:g("#876E00A1")},{name:"FurtherResearch",doc:g("#182687BF")},{name:"ConceptualWord",doc:g("#7C1872DB")},{name:"UseInArt",doc:g("#735581C2")},{name:"DoNotFullyUnderstand",doc:g("#2F7217D4")},{name:"DoNotAgree",doc:g("#940000A8")},{name:"WordDefine",doc:g("#3C3E42")}];this.plugin.settings.extraColors=this.plugin.settings.extraColors||[];for(let m of u)this.plugin.settings.extraColors.some(C=>(C.name||"").toLowerCase()===m.name.toLowerCase())||this.plugin.settings.extraColors.push({name:m.name,doc:m.doc,ui:d(m.doc),linked:!1});await this.plugin.saveSettings(),c(),this.plugin.refreshSidebar(),this.plugin.updateStyles()})),new E.Setting(t).setHeading().setName("Comments"),new E.Setting(t).setName("Use inline footnotes by default").setDesc("When adding comments via the sidebar, use inline footnotes (^[comment]) instead of standard footnotes ([^ref]: comment).").addToggle(a=>a.setValue(this.plugin.settings.useInlineFootnotes).onChange(async g=>{this.plugin.settings.useInlineFootnotes=g,await this.plugin.saveSettings()})),new E.Setting(t).setName("Select text on click").setDesc("When clicking a comment, select the comment instead of positioning the cursor in front of it.").addToggle(a=>a.setValue(this.plugin.settings.selectTextOnCommentClick).onChange(async g=>{this.plugin.settings.selectTextOnCommentClick=g,await this.plugin.saveSettings()})),new E.Setting(t).setHeading().setName("Filters"),new E.Setting(t).setName("Exclude Excalidraw files").setDesc("Skip .excalidraw files when scanning for highlights. This prevents highlights from being detected in Excalidraw drawing files.").addToggle(a=>a.setValue(this.plugin.settings.excludeExcalidraw).onChange(async g=>{this.plugin.settings.excludeExcalidraw=g,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()})),new E.Setting(t).setName("Excluded files").setDesc("Excluded files or folders will be hidden from Sidebar Highlights.").addButton(a=>{a.setButtonText("Manage").onClick(()=>{new Tt(this.app,this.plugin.settings.excludedFiles,async d=>{this.plugin.settings.excludedFiles=d,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()}).open()})})}updateColorMappings(){this.plugin.refreshSidebar(),this.plugin.updateStyles()}},kt=class{constructor(r){this.plugin=r}createCollection(r,t){let e={id:this.plugin.generateId(),name:r,description:t,highlightIds:[],createdAt:Date.now()};return this.plugin.collections.set(e.id,e),this.plugin.saveSettings(),this.plugin.registerCollectionCommands(),e}deleteCollection(r){let t=`go-to-collection-${r}`;this.plugin.collectionCommands.has(t)&&(this.plugin.removeCommand(t),this.plugin.collectionCommands.delete(t)),this.plugin.collections.delete(r),this.plugin.saveSettings()}async deleteCollectionWithConfirmation(r){let t=this.plugin.collections.get(r);return t&&confirm(`Are you sure you want to delete "${t.name}"?`)?(this.deleteCollection(r),!0):!1}addHighlightToCollection(r,t){let e=this.plugin.collections.get(r);e&&!e.highlightIds.includes(t)&&(e.highlightIds.push(t),this.plugin.saveSettings())}removeHighlightFromCollection(r,t){let e=this.plugin.collections.get(r);e&&(e.highlightIds=e.highlightIds.filter(i=>i!==t),this.plugin.saveSettings())}getAllCollections(){return Array.from(this.plugin.collections.values())}getCollection(r){return this.plugin.collections.get(r)}getCollectionStats(r){let t=this.plugin.collections.get(r);if(!t)return{highlightCount:0,fileCount:0,nativeCommentsCount:0};let e=new Set,i=0,s=0;for(let n of t.highlightIds)for(let[o,l]of this.plugin.highlights){let c=l.find(h=>h.id===n);if(c){e.add(o),c.isNativeComment?s++:i++;break}}return{highlightCount:i,fileCount:e.size,nativeCommentsCount:s}}getHighlightsInCollection(r){let t=this.plugin.collections.get(r);if(!t)return[];let e=[];for(let i of t.highlightIds)for(let[s,n]of this.plugin.highlights){let o=n.find(l=>l.id===i);if(o){e.push(o);break}}return e}getHighlightCollectionCount(r){let t=0;for(let e of this.plugin.collections.values())e.highlightIds.includes(r)&&t++;return t}getCollectionsForHighlight(r){let t=[];for(let e of this.plugin.collections.values())e.highlightIds.includes(r)&&t.push(e);return t}};
